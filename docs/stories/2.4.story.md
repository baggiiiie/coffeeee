# Story 2.4: AI-Guided Tasting Experience

## Status
Ready for Review

## Story
As a logged-in user, I want the app to ask me guiding questions about what I'm tasting, so that I can learn to identify and describe the flavors in my coffee myself.

## Acceptance Criteria
1. The Brew Log form includes an "AI Tasting Guide" button in the tasting notes section. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-24-revised-ai-guided-tasting-experience] [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
2. Clicking the button opens an interactive guide (modal or side panel) that proceeds step-by-step with questions and user-selectable answers; user can navigate Back/Next and Cancel at any time. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-24-revised-ai-guided-tasting-experience]
3. The guide presents follow-up questions based on prior answers (branching flow). The app may call `POST /api/v1/ai/recommendation` to obtain the next question given the user's previous selections. [Source: docs/architecture/backend-architecture.md#api-organization] [Source: docs/architecture/external-apis.md#ai-service-for-tasting-notes--brewing-suggestions]
4. The user’s selections are compiled into human-readable tasting notes and inserted into the Brew Log form’s `tastingNotes` field when the guide is completed; the user can edit these notes before saving. The app facilitates user-authored notes and does not insert AI-generated prose beyond formatting the user’s choices. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-24-revised-ai-guided-tasting-experience]
5. Error handling and UX: If the AI call fails, the guide shows a clear error message and allows retry; the user can continue manual note entry without data loss. [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
6. Usability and testing hooks: Progress indicator (e.g., step count), keyboard navigation, and `data-testid` attributes for guide container, step question, answer options, next/back/finish buttons. [Source: docs/architecture/frontend-architecture.md#component-design-patterns] [Source: docs/architecture/development-workflow.md#frontend-testing]
7. API contract: `POST /api/v1/ai/recommendation` request body is `{ "answers": Array<{ id: string, value: string }>, "context"?: { brewMethod?: string } }`; response body is `{ "questionId": string, "text": string, "options": Array<{ label: string, value: string }>, "hint"?: string }`. [Source: docs/architecture/backend-architecture.md#api-organization] [Source: docs/architecture/external-apis.md]
8. Timeout/retry policy and error mapping: Client times out recommendations at 10s and retries once with exponential backoff; after failure, shows a retry affordance. Map upstream/provider timeouts to `408` and provider errors to `502` with user-friendly messages. [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
9. Cancellation and persistence: Closing the guide preserves current selections in memory (until Brew Log form unmount); include a Reset button to clear selections explicitly. [Source: docs/architecture/frontend-architecture.md#component-design-patterns]
10. Accessibility: Modal/panel uses ARIA role `dialog`, labelled title, focus trap, ESC to close, and full keyboard navigation for options and controls. [Source: docs/architecture/frontend-architecture.md#component-design-patterns]

## Tasks / Subtasks
- [x] Frontend: Add AI Tasting Guide entry point (AC: 1)
  - [x] In `BrewLogForm`, place an “AI Tasting Guide” button in the tasting notes section. [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
- [x] Frontend: Implement `AITastingAssistant` component (AC: 2, 3, 4, 5, 6)
  - [x] Create `apps/frontend/src/components/AITastingAssistant.tsx` as a modal/side panel with step state, Back/Next/Finish/Cancel controls, and progress display. [Source: docs/architecture/frontend-architecture.md#component-design-patterns]
  - [x] Use a `useAI()` hook to request next-question prompts via `POST /api/v1/ai/recommendation` given prior answers and optional context (e.g., brew method). [Source: docs/architecture/frontend-architecture.md#custom-hooks] [Source: docs/architecture/backend-architecture.md#api-organization]
  - [x] Collect user’s selections per step; on Finish, compose structured notes (based on selections) and write to parent form’s `tastingNotes` field for user editing. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-24-revised-ai-guided-tasting-experience]
  - [x] Implement error states with retry; preserve current answers on errors; include `data-testid` markers for all controls/states. [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
  - [x] Enforce 10s request timeout with one retry using exponential backoff; after failure, show retry UI; on user retry, perform one backoff retry. [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
  - [x] Persist selections when guide closes; add Reset control to clear all selections. [Source: docs/architecture/frontend-architecture.md#component-design-patterns]
  - [x] Apply accessibility: ARIA-labelled dialog, focus trap, ESC to close, keyboard navigation for options and buttons. [Source: docs/architecture/frontend-architecture.md#component-design-patterns]
- [x] Backend: Ensure AI recommendation route (supporting AC: 3)
  - [x] Verify `POST /api/v1/ai/recommendation` route exists and proxies to configured provider via AI service; if missing, add handler skeleton that accepts prior answers context and returns a next-step question payload. [Source: docs/architecture/backend-architecture.md#api-organization] [Source: docs/architecture/external-apis.md]
  - [x] Add configuration surface for provider selection and API keys via existing `Config.AI` if not already wired. [Source: docs/architecture/backend-architecture.md#configuration-management]
  - [x] Document and conform to request/response schema in AC; map provider timeouts to `408` and provider errors to `502` with structured error payloads. [Source: docs/architecture/error-handling-strategy.md#structured-error-responses]
- [x] Tests
  - [x] Frontend: unit/component tests covering step navigation, AI call integration (mocked), error handling, and final note composition injected into form. [Source: docs/architecture/development-workflow.md#frontend-testing]
  - [x] Backend: basic handler test for `POST /api/v1/ai/recommendation` with mocked AI client to return a deterministic question. [Source: docs/architecture/development-workflow.md#backend-testing]

## Dev Agent Record
### Agent Model Used
James (Dev)

### Debug Log References
- Implemented `AITastingAssistant` with step navigation, reset, persistence, ARIA dialog
- Added `useAI` hook with 10s timeout and controlled retry; mapped 408/502 errors
- Wired AI Guide button in `BrewLogForm`; injected composed notes on finish
- Implemented backend `POST /api/v1/ai/recommendation` handler with deterministic branching and tests
- Ran frontend tests via `npm test '--workspace=apps/frontend' -- --run --silent`
- Ran backend tests with `GOCACHE=apps/backend/.gocache go test ./...`

### Completion Notes List
- AC 1–6 satisfied in frontend with test IDs and accessibility considerations (MUI Dialog handles focus trap/ESC)
- AC 7–8 satisfied: request/response schema adhered; timeout and error mapping implemented; retry on user action
- AC 9–10 satisfied: state persists when closed; Reset clears selections; keyboard navigation via RadioGroup
- Tests added/passing for assistant flow, error-retry, and BrewLog integration; backend handler tests pass

### File List
- apps/frontend/src/pages/BrewLogForm.tsx (AI Guide entry + integration)
- apps/frontend/src/components/AITastingAssistant.tsx (new in story; updated)
- apps/frontend/src/components/AITastingAssistant.test.tsx (new)
- apps/frontend/src/utils/useAI.ts (new in story; updated)
- apps/frontend/src/pages/BrewLogForm.test.tsx (updated to cover AI integration)
- apps/backend/internal/api/handlers/ai.go (new)
- apps/backend/internal/api/handlers/ai_recommendation_test.go (new)
- apps/backend/internal/api/routes/routes.go (wired route)

## Dev Notes
The following guidance is extracted from architecture and PRD; no assumptions beyond cited sources.

### Prior Context
- Brew Logging Workflow includes an AI tasting assistance step within the brew logging process. [Source: docs/architecture/core-workflows.md#brew-logging-workflow]
- Frontend component hierarchy includes `AITastingAssistant` under `BrewLogForm`. [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]

### AI Integration
- Backend provides `/api/v1/ai/recommendation` and `/api/v1/ai/extract-coffee` endpoints; this story uses `recommendation` to request next questions based on previous answers. [Source: docs/architecture/backend-architecture.md#api-organization]
- AI providers (OpenAI, Google Gemini) are integrated via a provider-agnostic `AIService`; authentication via provider API keys in configuration. [Source: docs/architecture/external-apis.md]
 - Request schema: `{ answers: Array<{ id: string, value: string }>, context?: { brewMethod?: string } }`; Response schema: `{ questionId: string, text: string, options: Array<{ label: string, value: string }>, hint?: string }`. [Source: docs/architecture/backend-architecture.md#api-organization]
 - Error handling: Client timeout of 10s with 1 retry; server maps timeouts to 408 and provider failures to 502 with user-friendly messages. [Source: docs/architecture/error-handling-strategy.md]

### Frontend Patterns
- Use custom hooks (`useAI`) for async interactions; presentational `AITastingAssistant` handles UI, containers orchestrate state. [Source: docs/architecture/frontend-architecture.md#custom-hooks] [Source: docs/architecture/frontend-architecture.md#component-design-patterns]
- Error handling flows through shared toast/notification patterns. [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
 - Accessibility: implement ARIA-labelled dialog/panel, focus trap, ESC to close, and full keyboard navigation. [Source: docs/architecture/frontend-architecture.md#component-design-patterns]

### File Locations / Project Structure
- Frontend: `apps/frontend/src/components/AITastingAssistant.tsx`; integrate with `apps/frontend/src/pages/BrewLogForm.tsx`. [Source: docs/architecture/source-tree.md#monorepo-organization]
- Backend: AI handler under `apps/backend/internal/api/handlers/ai.go` (or existing location) and route wiring under `.../routes/routes.go`; provider client under `internal/services/ai_service.go`. [Source: docs/architecture/backend-architecture.md#go-package-structure]

### Testing Requirements
- Frontend: deterministic tests with mocked AI responses for branching; verify `tastingNotes` composition equals the user’s choices. [Source: docs/architecture/development-workflow.md#frontend-testing]
- Backend: unit/integration tests for the recommendation handler invoking a mocked AI client and returning a question payload. [Source: docs/architecture/development-workflow.md#backend-testing]

### Technical Constraints
- The guide must not auto-generate full prose; it assists users to compose their own notes from their selections. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-24-revised-ai-guided-tasting-experience]

## Testing
- Frontend: tests for opening the guide, step navigation, error retry, and final note injection into the form. [Source: docs/architecture/development-workflow.md#frontend-testing]
- Backend: handler test for `POST /api/v1/ai/recommendation` with mocked provider. [Source: docs/architecture/development-workflow.md#backend-testing]

## Change Log
| Date | Version | Description | Author |
| {{DATE}} | 1.0 | Implemented AI Tasting Guide (Frontend + Backend) and tests | Dev |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.1 | Initial draft created for Story 2.4 | Scrum Master |

## Dev Agent Record
### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be completed by QA Agent_
