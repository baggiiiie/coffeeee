# Story 3.3: Start Brew from a Guide

## Status
Ready for Review

## Story
As a logged-in user, I want to start a new brew log directly from a brewing guide, so that the brewing parameters from the guide are pre-filled in my log.

## Acceptance Criteria
1. Each brewing guide page has a "Start Brewing with this Guide" button. [Source: docs/prd/epic-3-learning-guidance.md#story-33-start-brew-from-a-guide]
2. Clicking this button takes the user to the "Log New Brew" page. [Source: docs/prd/epic-3-learning-guidance.md#story-33-start-brew-from-a-guide] [Source: docs/architecture/frontend-architecture.md#routing-strategy]
3. The brewing parameters on the page are pre-filled with the values from the guide. [Source: docs/prd/epic-3-learning-guidance.md#story-33-start-brew-from-a-guide]
4. The user can then adjust these parameters as they perform their brew. [Source: docs/prd/epic-3-learning-guidance.md#story-33-start-brew-from-a-guide]

## Tasks / Subtasks
- [x] Frontend: Add CTA on guide detail (AC: 1)
  - [x] In `GuideDetail` (route `/guides/:slug`), add a primary button: "Start Brewing with this Guide" visible to authenticated users. [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
  - [x] Button navigates to `'/brew-logs/new'` carrying pre-fill parameters via router state (preferred) or query params fallback.
- [x] Frontend: Coffee selection flow (AC: 2–4)
  - [x] `BrewLogForm` requires a coffee before submit; if none is present in state, prompt the user to select one from their coffees (inline picker or navigate to CoffeeListPage). [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
  - [x] Preserve `initialBrewParams` while the user selects a coffee; on return, form initializes with both the selected coffee and prefill intact.
  - [x] Validate ownership on submit: selected coffee must belong to the authenticated user; block submit and show error if server returns 403. [Source: docs/architecture/api-specification.md#user-coffee-endpoints]
- [x] Frontend: Define pre-fill parameter mapping (AC: 3)
  - [x] Extend guide data to include a `brewPrefill` object with fields aligning to `BrewLog` model: `{ brewMethod, waterTemperature?, grindSize?, coffeeWeight?, waterWeight?, brewTime? }`. [Source: docs/architecture/data-models.md#brewlog-model]
  - [x] Ensure `brewMethod` matches enum/strings used by BrewLogForm options (e.g., "V60", "Chemex").
  - [x] Optional fields only pre-fill if provided by the guide; do not override user-entered values once changed.
- [x] Frontend: Apply pre-fill in BrewLog form (AC: 2, 3, 4)
  - [x] Update `BrewLogForm` to read `location.state.initialBrewParams` (or parse query) and set initial controlled form values accordingly. [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
  - [x] Display a non-blocking banner/note: "Prefilled from <Guide Title> — you can edit any field." with a "Reset to defaults" action.
  - [x] Maintain normal validation; prefilled values must pass existing validation rules.
- [x] UX, a11y, and edge cases (supports AC: 1–4)
  - [x] After navigation, move focus to Brew Log page heading for screen readers; button has accessible name and description. [Source: docs/architecture/frontend-architecture.md#component-design-patterns]
  - [x] Unknown or unsupported `:slug` → `GuideDetail` shows Not Found; CTA not rendered. If navigation occurs without state, `BrewLogForm` loads with standard empty defaults.
  - [x] If user is not authenticated, follow protected-route behavior: redirect to login then back to `/brew-logs/new` with prefill preserved.
  - [x] Prefill is not an autosave; user must confirm and submit to create the brew log.
- [x] Content/Data updates (supports AC: 3)
  - [x] Update V60 and Chemex guide data to include `brewPrefill` with reasonable defaults (method, temperature range midpoint, grind descriptor); images remain defined per Story 3.1.
  - [x] Centralize guide data in `apps/frontend/src/pages/guides/guideData.ts` to ensure a single source for list, detail, and pre-fill.
- [x] Tests
  - [x] Component test: `GuideDetail` renders CTA and navigates to `/brew-logs/new` with expected `initialBrewParams` in router state.
  - [x] Component test: `BrewLogForm` consumes prefill to initialize fields; user edits are preserved; Reset restores prefill values.
  - [x] Coffee selection test: no coffee selected → prompt/select owned coffee → prefill remains → submit succeeds with `POST /brewlogs` payload including `coffeeId` and prefilled params. [Source: docs/architecture/api-specification.md#brewlog-endpoints]
  - [x] Unauthorized coffee test: simulate server 403 on submit (non-owned coffee) → show error; allow re-selection and successful submit. [Source: docs/architecture/api-specification.md#user-coffee-endpoints]
  - [x] Routing test: unauthenticated user attempting CTA is redirected to login with prefill preserved in router state; verified via ProtectedRoute. [Source: docs/architecture/development-workflow.md#frontend-testing]

## Dev Notes
Extracted from PRD and Architecture; do not introduce new libraries.

- Routes and Components: `/guides` and `/guides/:slug` exist for guide list/detail; `/brew-logs/new` is the Brew Log creation page. Add CTA in `GuideDetail` and read prefill in `BrewLogForm`. [Source: docs/architecture/frontend-architecture.md#routing-strategy]
- BrewLog fields available for prefill are defined in the BrewLog model: `BrewMethod`, `CoffeeWeight`, `WaterWeight`, `GrindSize`, `WaterTemperature`, `BrewTime`. Only prefill those present in the guide. [Source: docs/architecture/data-models.md#brewlog-model]
- State Passing: Prefer React Router state for transferring `initialBrewParams` to avoid long query strings; provide a minimal query param fallback if state is unavailable (e.g., direct linking). Keep types in TS for safety. [Source: docs/architecture/frontend-architecture.md#component-design-patterns]
- Auth & Guards: Guides are in protected routes; rely on existing auth middleware and route guards. Ensure CTA is available only when the user is authenticated; otherwise the guard redirects appropriately. [Source: docs/architecture/frontend-architecture.md#routing-strategy]
- Source Tree: Place `GuideDetail` under `apps/frontend/src/pages` and CTA-related UI in that component; keep `guideData.ts` colocated under `pages/guides`. Static guide images remain in `apps/frontend/public/images/guides/...`. [Source: docs/architecture/source-tree.md]
 - Coffee Requirement & Ownership: `POST /brewlogs` requires a `coffeeId`; ensure the selected coffee is owned by the authenticated user (owner-only). Client should block submission if ownership check fails and surface backend 403s with clear messaging. [Source: docs/architecture/api-specification.md#brewlog-endpoints] [Source: docs/architecture/api-specification.md#user-coffee-endpoints]
 - No Autosave: Prefill sets initial values in the form but does not create a brew log until the user submits the form.

### Testing
- Use Jest + React Testing Library for UI and routing tests; mock router to assert state passing. Include `data-testid` on CTA and Brew Log form fields to assert prefill. [Source: docs/architecture/development-workflow.md#frontend-testing]
- Verify edge-case behavior: missing prefill, unauthenticated redirect/return with preserved state, and Not Found slug handling.

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.1 | Initial draft for Story 3.3 | Scrum Master |
| 2025-08-23 | 0.2 | Implemented CTA, prefill mapping, inline coffee selection, validation, and tests. | James (Dev) |

## Dev Agent Record
### Agent Model Used
James (Dev)

### Debug Log References
- Frontend tests updated and passing: `npm test --workspace=apps/frontend -- --run --silent` (40 tests total).
- New tests in `GuideDetail.test.tsx` (CTA + navigation) and `BrewLogForm.test.tsx` (prefill, selection, 403 handling).
 - Added routing test asserting prefill preserved across redirect to `/login` using `ProtectedRoute`.

### Completion Notes List
- Added CTA on GuideDetail with state-based prefill payload.
- Extended guide data with `brewPrefill` for V60 and Chemex.
- BrewLogForm now reads prefill from router state, shows a resettable info banner, and focuses heading after nav.
- Implemented inline coffee selection dropdown when no `coffeeId` is present; submission requires selection.
- Enhanced coffee selection with MUI Select for better UX and accessibility.
- Friendly error shown on 403 to reflect ownership constraint; normal validation retained.

### File List
- apps/frontend/src/pages/guides/guideData.ts (modified)
- apps/frontend/src/pages/GuideDetail.tsx (modified)
- apps/frontend/src/pages/GuideDetail.test.tsx (modified)
- apps/frontend/src/pages/BrewLogForm.tsx (modified)
- apps/frontend/src/pages/BrewLogForm.test.tsx (modified)

## QA Results
_To be completed by QA Agent_
