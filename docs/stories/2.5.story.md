# Story 2.5: View Brew History

## Status
Draft

## Story
As a logged-in user, I want to see a history of all the brews I have logged for a specific coffee, so that I can track my progress and see how my brew variables have changed over time.

## Acceptance Criteria
1. The Coffee Detail Page displays a list of all brew logs associated with that coffee for the authenticated user. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-25-view-brew-history]
2. Each list item shows key information: brew date (from `createdAt`) and the main tasting notes (first line/summary). [Source: docs/prd/epic-2-coffee-brew-logging.md#story-25-view-brew-history]
3. Clicking a brew log item navigates to the Brew Log Detail page (e.g., `/brew-logs/:id`) to view full details; this story depends on an existing or separate "Brew Log Detail" story to render the full record. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-25-view-brew-history] [Source: docs/architecture/frontend-architecture.md#routing-strategy]
4. Data is fetched from an authenticated endpoint that returns only logs for the current user and specified coffee, `GET /api/v1/brewlogs?coffeeId={id}`. Results are sorted by `createdAt` descending with a secondary sort by `id` descending for tiebreakers. [Source: docs/architecture/api-specification.md#brewlog-endpoints]
5. Pagination: Endpoint supports `limit` and `offset` query params; default `limit=20`. The UI loads the first page and can request more on demand (scoped to MVP as needed). [Source: docs/architecture/backend-architecture.md#api-organization]
6. Auth and error mapping: `401` when unauthenticated; `400` for invalid `coffeeId`; `403` when `coffeeId` refers to a coffee not linked to the user. Errors use structured payloads with user-friendly messages. [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]
7. Empty/error states: When no logs exist, show an empty-state message with a link/button to "Log New Brew"; on errors, show a user-friendly error with retry. Include `data-testid` hooks for list container, list item, empty-state, and error-state; list items are keyboard-navigable. [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling] [Source: docs/architecture/development-workflow.md#frontend-testing]

## Tasks / Subtasks
- [ ] Frontend: Coffee Detail Page integration (AC: 1, 2, 3, 5)
  - [ ] Add a `BrewLogList` section to the Coffee Detail Page that loads logs for the current coffee and renders a list/grid. [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
  - [ ] Each item displays formatted date (from `createdAt`) and a summary of `tastingNotes` (first line or trimmed preview); clicking navigates to `/brew-logs/:id`. [Source: docs/architecture/frontend-architecture.md#routing-strategy]
  - [ ] Handle loading, empty, and error states with toasts and on-page messages; add `data-testid` attributes. [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling] [Source: docs/architecture/development-workflow.md#frontend-testing]
- [ ] Frontend: Data fetching
  - [ ] Add API util to call `GET /api/v1/brewlogs?coffeeId={id}` with auth; support pagination parameters if present; default to sort by `createdAt` desc. [Source: docs/architecture/api-specification.md#brewlog-endpoints]
- [ ] Backend: List endpoint filter (AC: 4)
  - [ ] Implement/extend `GET /api/v1/brewlogs` to accept `coffeeId` query param; return only logs for the authenticated user and the specified coffee, sorted by `created_at` desc; support pagination (`limit`, `offset`). [Source: docs/architecture/backend-architecture.md#api-organization]
  - [ ] Validate `coffeeId` is a valid integer; return `400` for invalid; `401` if unauthenticated. [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]
- [ ] Tests (AC: 1–5)
  - [ ] Backend tests: coffeeId filter returns only matching logs for the authenticated user; sorted order; invalid coffeeId (400); unauthenticated (401). [Source: docs/architecture/development-workflow.md#backend-testing]
  - [ ] Frontend tests: list renders with items, item click navigates to detail, empty-state shown when none, and error state displays on fetch failure. [Source: docs/architecture/development-workflow.md#frontend-testing]

## Dev Notes
The following guidance is extracted from architecture and PRD; no assumptions beyond cited sources.

### Previous Story Insights
- 2.3 created Brew Logs via `POST /api/v1/brewlogs` and redirects to Coffee Detail; this story surfaces those logs for the selected coffee. [Source: docs/stories/2.3.story.md]

### Data Models
- BrewLog includes: `ID`, `UserID`, `CoffeeID`, `BrewMethod`, `CoffeeWeight`, `WaterWeight`, `GrindSize`, `WaterTemperature` (°C), `BrewTime` (seconds), `TastingNotes`, `Rating`, `CreatedAt`. [Source: docs/architecture/data-models.md#brewlog-model]
- DB schema enforces FKs to users/coffees and indexes for `created_at`; use ORDER BY `created_at` DESC for history. [Source: docs/architecture/database-schema.md#sqlite-schema-definition]

### API Specifications
- Use `GET /api/v1/brewlogs?coffeeId={id}` to retrieve logs for the authenticated user for a specific coffee; return array of BrewLog objects sorted by `createdAt` desc. [Source: docs/architecture/api-specification.md#brewlog-endpoints]
- Error handling: `400` invalid `coffeeId`, `401` unauthenticated; use structured error payloads. [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]

### Component Specifications
- Coffee Detail Page contains `BrewLogList`; clicking an item navigates to `BrewLog` detail page. [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
- Show formatted dates and brief tasting notes summary; mm:ss display for `brewTime` remains in detail view, not required for list. [Source: docs/architecture/frontend-architecture.md#component-design-patterns]

### File Locations / Project Structure
- Backend: extend handler `apps/backend/internal/api/handlers/brewlog.go` and routes; repository/service add list-by-user-and-coffee method. [Source: docs/architecture/backend-architecture.md#go-package-structure]
- Frontend: update `apps/frontend/src/pages/CoffeeDetailPage.tsx` to include `BrewLogList` and navigation; shared fetch util in `apps/frontend/src/utils/api.ts`. [Source: docs/architecture/source-tree.md#monorepo-organization]

### Testing Requirements
- Backend: sorting, filtering, and auth validation tests for list endpoint. [Source: docs/architecture/development-workflow.md#backend-testing]
- Frontend: component and routing tests for list rendering and navigation; empty/error states. [Source: docs/architecture/development-workflow.md#frontend-testing]

## Testing
- Backend: API integration tests verifying filtered, sorted results and proper errors. [Source: docs/architecture/development-workflow.md#api-integration-testing]
- Frontend: tests for list rendering, navigation, empty/error states with stable test IDs. [Source: docs/architecture/development-workflow.md#frontend-testing]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.1 | Initial draft created for Story 2.5 | Scrum Master |

## Dev Agent Record
### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be completed by QA Agent_
