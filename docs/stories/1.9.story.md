# Story 1.9: Profile Management

## Status
Approved

## Story
As an authenticated user, I want to update my profile information, so that I can keep my account details current and personalize my experience.

## Acceptance Criteria
1. Backend endpoint `PUT /api/v1/users/me` updates the authenticated user's profile when provided valid data.
   - Request body accepts `{ "username"?: string, "email"?: string }` (both optional).
   - 200 response returns updated user: `{ "id", "username", "email", "createdAt", "updatedAt" }`.
   - 400 on invalid data (e.g., invalid email format, empty username).
   - 409 if email is already in use by another user.
   - 401 on missing/invalid token.
   - Response header: `Content-Type: application/json; charset=utf-8`
   [Source: docs/architecture/api-specification.md#user--authentication-endpoints] [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]
2. Frontend profile page allows editing username and email with validation.
   - Form shows current values from `AuthContext.user`.
   - Real-time validation: email format (`^[^\s@]+@[^\s@]+\.[^\s@]+$`), username pattern (`^[a-zA-Z0-9_-]{3,50}$`), at least one field provided.
   - Submit button disabled until form is valid and changed (dirty state).
   - Loading state during submission.
   [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy] [Source: docs/architecture/frontend-architecture.md#component-design-patterns]
3. Success/error feedback:
   - On success: show success message "Profile updated successfully", update `AuthContext.user`, and reflect changes in header.
   - On error: show specific error message (e.g., "Email format is invalid", "Username must be 3-50 characters", "Email already in use").
   - Use existing toast/notification system with appropriate styling.
   [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
4. Form UX:
   - Cancel button resets form to original values from `AuthContext.user`.
   - Unsaved changes warning on navigation away (e.g., using `react-router` `Prompt` component).
   - Responsive design for mobile/desktop.
   - Form elements include `data-testid` attributes for stable testing.
   [Source: docs/architecture/frontend-architecture.md#styling-architecture]

## Tasks / Subtasks
- [x] Backend: Implement `PUT /api/v1/users/me` (AC: 1)
  - [x] In `apps/backend/internal/api/handlers/user.go#UpdateProfile`, read user ID from request context (JWT middleware)
  - [x] Parse request body `{ "username"?: string, "email"?: string }` with validation
  - [x] Validate: email format (`^[^\s@]+@[^\s@]+\.[^\s@]+$`), username pattern (`^[a-zA-Z0-9_-]{3,50}$`), at least one field provided
  - [x] Check email uniqueness if email is being updated (exclude current user)
  - [x] Update DB and return 200 with updated user JSON; handle 400/409/401 errors with specific messages
  - [x] Set `Content-Type: application/json; charset=utf-8`
  [Source: docs/architecture/api-specification.md#user--authentication-endpoints] [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]
- [x] Backend: Ensure route wiring (AC: 1)
  - [x] Confirm `protected.HandleFunc("/users/me", userHandler.UpdateProfile).Methods("PUT")` is enabled under protected subrouter (already present)
  [Source: apps/backend/internal/api/routes/routes.go]
- [x] Frontend: Profile form component (AC: 2, 4)
  - [x] Create `apps/frontend/src/components/ProfileForm.tsx` with Material-UI form fields for username and email
  - [x] Implement real-time validation using specified regex patterns
  - [x] Track form dirty state by comparing current values to original `AuthContext.user` values
  - [x] Add loading state, submit/cancel buttons with `data-testid="submit-button"` and `data-testid="cancel-button"`
  - [x] Handle unsaved changes warning using `beforeunload` guard (navigation warning)
  [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy] [Source: docs/architecture/frontend-architecture.md#component-design-patterns]
- [x] Frontend: Profile page integration (AC: 2, 3)
  - [x] Update `apps/frontend/src/pages/UserProfilePage.tsx` to use `ProfileForm` and display current user data
  - [x] Wire form submission to `PUT /api/v1/users/me` via API module
  - [x] On success: update `AuthContext.user`, show success message "Profile updated successfully", reflect in header via context state
  - [x] On error: show specific error message with validation/conflict details
  [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy] [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
- [x] Frontend: AuthContext update (AC: 3)
  - [x] Add `updateProfile(profileData: UpdateUserRequest)` to `AuthContext` to update local user state
  - [x] Ensure header reflects updated username/email immediately
  [Source: docs/architecture/frontend-architecture.md#state-management-strategy]
- [x] Tests (AC: 1, 2, 3)
  - [x] Backend integration tests: valid updates return 200, validation errors return 400 with specific messages, email conflict returns 409
  - [x] Frontend validation tests: invalid email formats, username too short/long, empty submission, form dirty state tracking
  - [x] Frontend submission tests: success/error states, AuthContext updates, header reflects changes, submit button enable/disable
  [Source: docs/architecture/development-workflow.md#backend-testing] [Source: docs/architecture/development-workflow.md#frontend-testing]

## Dev Notes
The following guidance is extracted from architecture and prior stories; no assumptions beyond cited sources.

### Dependencies
- Depends on Story 1.6 (JWT middleware) for context-based authentication.
- Depends on Story 1.7 (User hydration) for current user data.
- Depends on Story 1.8 (Auth persistence) for consistent session handling.
  [Source: docs/stories/1.6.story.md] [Source: docs/stories/1.7.story.md] [Source: docs/stories/1.8.story.md]

### Backend Architecture & Organization
- Protected routes already define `/users/me` PUT under the protected subrouter using `AuthMiddleware(cfg.JWT.Secret)`. Implement profile updates in `UserHandler.UpdateProfile`. [Source: apps/backend/internal/api/routes/routes.go] [Source: docs/architecture/backend-architecture.md#middleware-stack]
- Use structured error responses for 400/409/401 as per error handling strategy. [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]

### Frontend Architecture
- Use Material-UI form components with validation patterns from the component design guide. [Source: docs/architecture/frontend-architecture.md#component-design-patterns]
- Integrate with existing toast/notification system for success/error feedback. [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
- Follow responsive design patterns using MUI breakpoints. [Source: docs/architecture/frontend-architecture.md#styling-architecture]

### Validation Rules
- Email: `^[^\s@]+@[^\s@]+\.[^\s@]+$` (standard email format)
- Username: `^[a-zA-Z0-9_-]{3,50}$` (alphanumeric + underscore/hyphen, 3-50 chars)
- At least one field must be provided for update
- Email uniqueness check excludes the current user

### Form State Management
- Track "dirty" state by comparing current form values to original `AuthContext.user` values
- Submit button enabled only when form is valid AND dirty
- Cancel button resets to original values from `AuthContext.user`

### Error Message Examples
- "Email format is invalid"
- "Username must be 3-50 characters and contain only letters, numbers, underscores, and hyphens"
- "At least one field must be provided"
- "Email already in use by another account"

### File Locations / Project Structure
- Backend: `apps/backend/internal/api/handlers/user.go`, `apps/backend/internal/api/routes/routes.go`
- Frontend: `apps/frontend/src/pages/UserProfilePage.tsx`, `apps/frontend/src/components/ProfileForm.tsx`, `apps/frontend/src/context/AuthContext.tsx`
[Source: docs/architecture/source-tree.md#monorepo-organization]

### Testing Requirements
- Backend: validation error paths, email conflict scenarios, successful updates.
- Frontend: form validation, submission states, AuthContext updates, UI feedback.
[Source: docs/architecture/development-workflow.md#backend-testing] [Source: docs/architecture/development-workflow.md#frontend-testing]

### Technical Constraints
- Go backend with JWT middleware; React 18 + TypeScript frontend; Material-UI for components. [Source: docs/architecture/tech-stack.md#technology-stack-table]

## Testing
- Backend: integration tests for valid updates, validation errors, email conflicts, and authentication failures. [Source: docs/architecture/development-workflow.md#backend-testing]
- Frontend: form validation, submission success/error states, AuthContext updates, and header reflection. [Source: docs/architecture/development-workflow.md#frontend-testing]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.2 | Added validation regex, form state management, unsaved changes implementation, error messages, test cases, and data-testid attributes | Scrum Master |
| {{DATE}} | 0.1 | Initial draft created for Story 1.9 | Scrum Master |

## Dev Agent Record
### Agent Model Used
James (dev) via Codex CLI

### Debug Log References
- Implemented backend handler and tests: `apps/backend/internal/api/handlers/user.go`, `apps/backend/internal/api/handlers/user_update_test.go`
- Verified routes: `apps/backend/internal/api/routes/routes.go`
- Added ProfileForm and page integration: `apps/frontend/src/components/ProfileForm.tsx`, `apps/frontend/src/pages/UserProfilePage.tsx`
- Added AuthContext update method: `apps/frontend/src/context/AuthContext.tsx`
- Added frontend tests: `apps/frontend/src/components/ProfileForm.test.tsx`, `apps/frontend/src/pages/UserProfilePage.test.tsx`

### Completion Notes List
- Backend `PUT /api/v1/users/me` implemented with validation, conflict handling, and JSON responses per AC.
- Frontend form provides real-time validation, dirty-state, and cancel reset; navigation warning via `beforeunload`.
- Profile page integrates form, updates `AuthContext.user`, and shows success/error feedback.
- Frontend tests pass via `npm test --workspace=apps/frontend -- --run --silent`.
- Backend tests added but not executed here due to sandboxed network (Go module fetch). CI should run them.

### File List
- Modified: `apps/backend/internal/api/handlers/user.go`
- Added: `apps/backend/internal/api/handlers/user_update_test.go`
- Added: `apps/frontend/src/components/ProfileForm.tsx`
- Modified: `apps/frontend/src/pages/UserProfilePage.tsx`
- Modified: `apps/frontend/src/context/AuthContext.tsx`
- Added: `apps/frontend/src/components/ProfileForm.test.tsx`
- Added: `apps/frontend/src/pages/UserProfilePage.test.tsx`

## QA Results
_To be completed by QA Agent_
