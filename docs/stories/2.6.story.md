# Story 2.6: Photo Storage for Coffee Images

## Status
Draft

## Story
As a logged-in user, I want the app to store a photo of my coffee bag when I add a coffee to my collection, so that my “My Coffees” gallery and detail pages can display the image reliably.

## Acceptance Criteria
1. Upload endpoint: `POST /api/v1/users/me/coffees/{coffeeId}/photo` accepts `multipart/form-data` with a single image file field `photo`. Returns `201 Created` with the updated coffee including `photoPath` and `Content-Type: application/json; charset=utf-8`. [Source: docs/architecture/backend-architecture.md#api-organization] [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]
2. Validation and size limits: Only JPEG or PNG images up to 5MB are accepted; otherwise return `400` for invalid type and `413` for payload too large. [Source: docs/architecture/coding-standards.md#go-coding-standards]
3. Storage: The server saves images to a local uploads directory (e.g., `uploads/coffee-photos/{userId}/{coffeeId}/{uuid}.jpg|png`) and stores the relative path on the coffee record (`coffees.photo_path`). [Source: docs/architecture/source-tree.md#monorepo-organization] [Source: docs/architecture/database-schema.md#database-relationships]
4. Serving: Stored images are retrievable via a static route (e.g., `GET /static/coffee-photos/...`) with proper `Content-Type` and caching headers; the `photoPath` returned by upload can be used directly by the frontend to render the image. [Source: docs/architecture/backend-architecture.md#api-organization]
5. Security: Only the authenticated owner (where `coffees.user_id` matches the current user) can upload/replace the photo for that coffee; unauthorized access returns `401/403` as appropriate. [Source: docs/architecture/backend-architecture.md#middleware-stack]

## Tasks / Subtasks
- [ ] Backend: Data model confirmation (AC: 3)
  - [ ] Ensure `coffees` table includes `photo_path` (string up to 500 chars) and that coffees are user-owned via `user_id`. No join table is used for photos. [Source: docs/architecture/database-schema.md#database-relationships]
- [ ] Backend: Upload endpoint (AC: 1, 2, 3, 5)
  - [ ] Add handler `UploadUserCoffeePhoto(w http.ResponseWriter, r *http.Request)` under protected routes at `POST /api/v1/users/me/coffees/{coffeeId}/photo`. [Source: docs/architecture/backend-architecture.md#api-organization]
  - [ ] Enforce max body size (5MB + form overhead) and validate MIME type (JPEG/PNG) before saving; return structured errors on failure. [Source: docs/architecture/error-handling-strategy.md#structured-error-responses]
  - [ ] Generate deterministic storage path: `uploads/coffee-photos/{userId}/{coffeeId}/{uuid}.{ext}`; create directories as needed; set secure file permissions. [Source: docs/architecture/coding-standards.md#go-coding-standards]
  - [ ] Persist relative `photo_path` on the `coffees` record (scoped by `WHERE id = {coffeeId} AND user_id = {currentUserId}`) and return JSON including this path. [Source: docs/architecture/database-schema.md#database-relationships]
- [ ] Backend: Static file serving (AC: 4)
  - [ ] Expose a static route prefix `/static/coffee-photos/` mapped to `uploads/coffee-photos/` with correct `Content-Type` and sensible cache headers. [Source: docs/architecture/backend-architecture.md#api-organization]
  - [ ] Consider a simple middleware to prevent directory listing and to sanitize paths. [Source: docs/architecture/backend-architecture.md#middleware-stack]
- [ ] Backend: Configuration (supporting AC: 3–4)
  - [ ] Add config values: `UPLOAD_DIR` (default `uploads/coffee-photos`), `MAX_UPLOAD_MB` (default `5`). Wire via `config.Config`. [Source: docs/architecture/backend-architecture.md#configuration-management]
- [ ] Frontend: Form integration (AC: 1, 4)
  - [ ] In `CoffeeNewPage`, after creating/finding the coffee (Story 2.1), if the user selected a file, upload via `POST /api/v1/users/me/coffees/{coffeeId}/photo` using `FormData`. [Source: docs/stories/2.1.story.md]
  - [ ] Update UI to show server-returned photo (via `photoPath`) and keep local preview as optimistic UI until confirmed. [Source: docs/architecture/frontend-architecture.md#component-design-patterns]
- [ ] Frontend: Gallery integration (AC: 4)
  - [ ] In `MyCoffeesPage`, render the stored `photoPath` if present; fallback to placeholder otherwise. [Source: docs/stories/2.2.story.md]
- [ ] Tests
  - [ ] Backend: multipart upload success path (JPEG/PNG), invalid type (400), too large (413), unauthorized (401), forbidden (403) cases; verify `coffees.photo_path` is updated for the authenticated owner only. [Source: docs/architecture/development-workflow.md#backend-testing]
  - [ ] Frontend: mock upload flow (FormData) and confirm image renders from returned `coffee.photoPath`; handle error toast on failures. [Source: docs/architecture/development-workflow.md#frontend-testing]

## Dev Notes
The following guidance is extracted from architecture; no assumptions beyond cited sources.

### Data Models
- Coffees are user-owned (`coffees.user_id` references `users.id`) and store the per-coffee photo path at `coffees.photo_path`. No `user_coffees` join table is used for photos. [Source: docs/architecture/database-schema.md#database-relationships]

### API Specifications
- Protected upload endpoint under `/api/v1/users/me/coffees/{coffeeId}/photo` for authenticated users only; responds with JSON including `coffee.photoPath`. [Source: docs/architecture/backend-architecture.md#api-organization]
- Serve images from `/static/coffee-photos/...` path mapped to local `uploads` directory. [Source: docs/architecture/backend-architecture.md#api-organization]

### File Locations / Project Structure
- Backend handlers/routes under `apps/backend/internal/api/handlers` and `.../routes`; config under `internal/config`; migrations under `apps/backend/migrations`. [Source: docs/architecture/backend-architecture.md#go-package-structure]
- Frontend pages/components under `apps/frontend/src/pages` and `.../components`; API utilities under `.../utils`. [Source: docs/architecture/source-tree.md#monorepo-organization]

### Technical Constraints
- Tech stack currently lists File Storage as N/A; this story introduces minimal local disk storage scoped to MVP only. Future stories may migrate to cloud storage (e.g., S3) with signed URLs. [Source: docs/architecture/tech-stack.md#technology-stack-table]
- Ensure security via auth middleware; do not permit access to other users’ folders. [Source: docs/architecture/backend-architecture.md#middleware-stack]

## Testing
- Backend: multipart upload tests covering type/size validation, auth, persistence, and static serving correctness. [Source: docs/architecture/development-workflow.md#backend-testing]
- Frontend: unit/component tests for upload flow, success/error UI, and gallery rendering of stored images. [Source: docs/architecture/development-workflow.md#frontend-testing]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.1 | Initial draft for per-user photo storage | Scrum Master |

## Dev Agent Record
### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be completed by QA Agent_
