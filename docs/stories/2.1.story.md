# Story 2.1: Create Coffee "Journey" Log

## Status
Ready for Review

## Story
As a logged-in user, I want to add a new coffee to my personal collection by uploading a photo of the bag and adding details, so that I can keep a record of all the coffees I have tried.

## Acceptance Criteria
1. The authenticated dashboard has a button to "Add New Coffee." [Source: docs/prd/epic-2-coffee-brew-logging.md#story-21-create-coffee-"journey"-log]
2. The "Add New Coffee" page has fields for coffee name, roaster, origin, etc., and a file upload for the bag photo. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-21-create-coffee-"journey"-log]
3. The backend exposes `POST /api/v1/users/me/coffees` to add a coffee to the authenticated user's collection. If the coffee does not exist, it is created; otherwise, the existing coffee is linked. Response returns the linked coffee object (and link metadata if applicable). [Source: docs/prd/epic-2-coffee-brew-logging.md#story-21-create-coffee-"journey"-log] [Source: docs/architecture/backend-architecture.md#api-organization]
4. (Stretch) The backend sends the uploaded photo to an AI service to attempt to extract text and pre-fill the form fields. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-21-create-coffee-"journey"-log]

## Tasks / Subtasks
- [x] Frontend: Add dashboard Quick Action (AC: 1)
  - [x] Add an "Add New Coffee" button in `Dashboard` quick actions linking to the new coffee form route. [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
- [x] Frontend: New Coffee Form page (AC: 2)
  - [x] Create `apps/frontend/src/pages/CoffeeNewPage.tsx` with fields: name (required), roaster (optional), origin (optional), description (optional), photo upload control. [Source: docs/architecture/components.md#frontend-components-pagesviews] [Source: docs/architecture/data-models.md#coffee-model]
  - [x] Validate name non-empty; limit inputs according to model constraints (e.g., name <= 255). [Source: docs/architecture/database-schema.md#sqlite-schema-definition]
  - [x] On submit, POST JSON to `/api/v1/users/me/coffees`; handle success/error toasts. [Source: docs/architecture/backend-architecture.md#api-organization] [Source: docs/architecture/error-handling-strategy.md]
  - [x] Include `data-testid` attributes for fields and submit button. [Source: docs/architecture/development-workflow.md#frontend-testing]
- [x] Backend: User-coffee creation endpoint (AC: 3)
  - [x] Add join table `user_coffees` with schema: `id`, `user_id` (FK), `coffee_id` (FK), optional `photo_path`, `created_at`; unique index on `(user_id, coffee_id)`. [Source: docs/architecture/database-schema.md#database-relationships]
  - [x] Implement handler `POST /api/v1/users/me/coffees` to accept `{ "name", "origin"?, "roaster"?, "description"?, "photoPath"? }`. Create or find coffee, then create link record for the user. [Source: docs/architecture/backend-architecture.md#api-organization]
  - [x] Return `201 Created` with linked Coffee object (and link metadata if included); validate required fields and respond with structured errors. [Source: docs/architecture/error-handling-strategy.md#structured-error-responses]
- [x] Photo upload handling (AC: 2, 4) — Project constraint note
  - [x] Provide client-side file input and preview only; file storage not defined in MVP tech stack. Record constraint in Dev Notes. [Source: docs/architecture/tech-stack.md#technology-stack-table]
  - [ ] If implementing stretch: send image to backend AI extraction endpoint for text extraction, or disable as non-blocking UI affordance. [Source: docs/architecture/backend-architecture.md#api-organization] [Source: docs/architecture/external-apis.md#ai-service-for-tasting-notes--brewing-suggestions]
- [x] Tests (AC: 1–3)
  - [x] Frontend: component tests for validation and submission success/error states. [Source: docs/architecture/development-workflow.md#frontend-testing]
  - [x] Backend: integration test for `POST /api/v1/users/me/coffees` happy path and validation errors. [Source: docs/architecture/development-workflow.md#api-integration-testing]

## Dev Notes
The following guidance is extracted from architecture and PRD; no assumptions beyond cited sources.

### Previous Story Insights
- Authenticated routing and JWT-protected endpoints are established for profile operations; reuse the protected subrouter and AuthContext patterns for authenticated coffee creation. [Source: docs/stories/1.9.story.md] [Source: docs/architecture/backend-architecture.md#middleware-stack] [Source: docs/architecture/frontend-architecture.md#state-management-strategy]

### Data Models
- Coffee model fields: `Name` (required), `Origin` (optional), `Roaster` (optional), `Description` (optional), timestamps. [Source: docs/architecture/data-models.md#coffee-model]
- Add join model `UserCoffee` linking user to coffee with optional `PhotoPath`, `CreatedAt`. Unique per `(user_id, coffee_id)`. [Source: docs/architecture/database-schema.md#database-relationships]

### API Specifications
- User collection endpoint: `POST /api/v1/users/me/coffees` to add to the authenticated user's collection; request `{ "name", "origin"?, "roaster"?, "description"?, "photoPath"? }`, response Coffee with link metadata as needed. [Source: docs/architecture/backend-architecture.md#api-organization]
- Error handling must use structured error responses with clear messages for validation failures. [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]

### Component Specifications
- Add Quick Action button on Dashboard; implement a dedicated New Coffee form page within protected routes. [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
- Use Material-UI components; responsive design via MUI breakpoints. [Source: docs/architecture/frontend-architecture.md#styling-architecture]

### File Locations / Project Structure
- Backend: `apps/backend/internal/api/handlers/coffee.go`, `apps/backend/internal/api/routes/routes.go`, service/repository layers under `internal/services` and `internal/repository`. [Source: docs/architecture/backend-architecture.md#go-package-structure]
- Frontend: `apps/frontend/src/pages/CoffeeNewPage.tsx` (new), potential additions to `apps/frontend/src/pages/Dashboard.tsx` quick actions, shared API util in `apps/frontend/src/utils/`. [Source: docs/architecture/source-tree.md#monorepo-organization]

### Testing Requirements
- Frontend: Jest + React Testing Library component tests covering validation rules, submission success/error, and presence of `data-testid` markers. [Source: docs/architecture/development-workflow.md#frontend-testing]
- Backend: API integration tests for `POST /api/v1/coffees` verifying `201` on success and `400` on invalid input. [Source: docs/architecture/development-workflow.md#api-integration-testing]

### Technical Constraints
- MVP tech stack lists File Storage as N/A; server-side file upload/storage is not defined. Treat photo upload as UI-only preview or defer storage; document as constraint. [Source: docs/architecture/tech-stack.md#technology-stack-table]
- AI extraction is optional; backend includes `/api/v1/ai/extract-coffee` route in architecture for future integration. [Source: docs/architecture/backend-architecture.md#api-organization] [Source: docs/architecture/external-apis.md]

### Project Structure Notes
- Ensure new files align with source tree conventions for pages/components. [Source: docs/architecture/source-tree.md#monorepo-organization]
- Ownership model: implement per-user linkage via `user_coffees` join table and user-specific endpoint. Document follow-up for full file storage strategy and AI extraction.

## Testing
- Frontend: unit/component tests for the New Coffee form validation and submission flows. [Source: docs/architecture/development-workflow.md#frontend-testing]
- Backend: integration tests for coffee creation endpoint covering success and validation errors. [Source: docs/architecture/development-workflow.md#api-integration-testing]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.1 | Initial draft created for Story 2.1 | Scrum Master |
| 2025-08-21 | 1.0 | Implemented backend endpoint, migrations, frontend form and quick action; tests added and passing | James |

## Dev Agent Record
### Agent Model Used
James (Dev Agent) — implementation via local tools

### Debug Log References
- Backend: go test ./... passed (handlers, middleware, migrate)
- Frontend: vitest suite passed, including CoffeeNewPage tests
- Added migration 002 for user_coffees; adjusted migration test to reflect multi-migration down behavior

### Completion Notes List
- Implemented user_coffees join table and protected endpoint POST `/api/v1/users/me/coffees` (find-or-create + link, 201 Created).
- Frontend CoffeeNewPage with validation and MUI UI-only photo upload preview per MVP constraint (no server upload).
- Added Dashboard quick action linking to New Coffee form.
- Wrote backend integration tests and frontend component tests; all tests passing locally.

### File List
- apps/backend/migrations/002_user_coffees.up.sql (added)
- apps/backend/migrations/002_user_coffees.down.sql (added)
- apps/backend/internal/api/handlers/coffee.go (updated: CreateForMe handler)
- apps/backend/internal/api/handlers/coffee_user_test.go (added)
- apps/backend/internal/api/routes/routes.go (updated: route for /users/me/coffees)
- apps/backend/internal/migrate/runner_test.go (updated to handle multi-migration down)
- apps/frontend/src/pages/CoffeeNewPage.tsx (added)
- apps/frontend/src/pages/CoffeeNewPage.test.tsx (added)
- apps/frontend/src/pages/Dashboard.tsx (updated: quick action button)
- apps/frontend/src/App.tsx (updated: route for /coffees/new)

## QA Results
_To be completed by QA Agent_
