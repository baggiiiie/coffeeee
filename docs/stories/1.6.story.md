# Story 1.6: Backend JWT Authentication Middleware

## Status
Draft

## Story
As the system, I want protected API routes to require a valid JWT, so that only authenticated users can access resources that require authentication.

## Acceptance Criteria
1. Implement JWT authentication middleware that:
   - Extracts the token from the `Authorization: Bearer <token>` header
   - Validates signature using configured secret and checks expiry/claims
   - On success, attaches the authenticated user (or user ID/claims) to request context
   - On failure, returns `401` with a structured error per error handling strategy
   [Source: docs/architecture/backend-architecture.md#middleware-stack] [Source: docs/architecture/backend-architecture.md#configuration-management] [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]
2. Apply the middleware to protected routes in the router setup (users, coffees write, brewlogs, ai). [Source: apps/backend/internal/api/routes/routes.go]
3. Requests to protected routes without a valid token receive `401` and a consistent error body. [Source: docs/architecture/api-specification.md#user--authentication-endpoints] [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]
4. Valid tokens allow access; downstream handlers can retrieve user identity from context. [Source: docs/architecture/backend-architecture.md#middleware-stack]

## Tasks / Subtasks
- [ ] Middleware Implementation (AC: 1, 4)
  - [ ] Implement `AuthMiddleware(jwtSecret string)` in `apps/backend/internal/api/middleware/middleware.go` to:
    - [ ] Parse `Authorization` header, validate `Bearer` format
    - [ ] Verify JWT using configured secret; validate expiry
    - [ ] Extract claims (e.g., `sub` user ID); set in `context.Context`
    - [ ] On error, respond with 401 using structured API error
    [Source: docs/architecture/backend-architecture.md#middleware-stack] [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]
- [ ] Context Utilities (AC: 4)
  - [ ] Add helper to read user ID/claims from context in handlers (new file if needed, e.g., `apps/backend/internal/api/middleware/auth_context.go`) [Source: docs/architecture/backend-architecture.md#middleware-stack]
- [ ] Router Wiring (AC: 2)
  - [ ] Ensure `protected.Use(middleware.AuthMiddleware(cfg.JWT.Secret))` remains applied to protected subrouter in `apps/backend/internal/api/routes/routes.go` [Source: apps/backend/internal/api/routes/routes.go]
- [ ] Tests (AC: 1, 3, 4)
  - [ ] Unit test middleware: missing header → 401; malformed token → 401; expired token → 401; valid token → next handler called and context populated [Source: docs/architecture/development-workflow.md#backend-testing]
  - [ ] Integration test: sample protected endpoint returns 200 with valid token, 401 without/invalid token [Source: docs/architecture/development-workflow.md#backend-testing]

## Dev Notes
The following guidance is extracted from architecture docs; no assumptions beyond cited sources.

### Backend Architecture & Organization
- Middleware stack includes authentication; config provides `JWT` secret. Implement in `apps/backend/internal/api/middleware/middleware.go` and apply in router. [Source: docs/architecture/backend-architecture.md#middleware-stack] [Source: docs/architecture/backend-architecture.md#configuration-management]
- Use structured errors for consistent `401` responses. [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]

### API Specifications
- Protected resources include `GET/PUT/DELETE /users/me`, coffee write endpoints, brew log endpoints, and AI endpoints. [Source: docs/architecture/api-specification.md#user--authentication-endpoints]

### File Locations / Project Structure
- Middleware: `apps/backend/internal/api/middleware/middleware.go`
- Routes: `apps/backend/internal/api/routes/routes.go`
- Optional context helpers: `apps/backend/internal/api/middleware/auth_context.go` (if added)
[Source: docs/architecture/backend-architecture.md#go-package-structure]

### Testing Requirements
- Backend tests should cover positive/negative paths for JWT verification and context propagation. [Source: docs/architecture/development-workflow.md#backend-testing]

### Technical Constraints
- Go 1.22.x, standard library + a minimal JWT library if already chosen; otherwise follow architecture guidance and consistent dependency policy. [Source: docs/architecture/tech-stack.md#technology-stack-table]

## Testing
- Unit tests for middleware on header parsing, verification, expiry, and context injection. [Source: docs/architecture/development-workflow.md#backend-testing]
- Integration tests hitting protected routes with and without valid tokens. [Source: docs/architecture/development-workflow.md#backend-testing]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.1 | Initial draft created for Story 1.6 | Scrum Master |

## Dev Agent Record
### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be completed by QA Agent_
