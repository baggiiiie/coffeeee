# Story 1.6: Backend JWT Authentication Middleware

## Status
Ready for Review

## Story
As the system, I want protected API routes to require a valid JWT, so that only authenticated users can access resources that require authentication.

## Acceptance Criteria
1. Implement JWT authentication middleware that:
   - Extracts the token from the `Authorization: Bearer <token>` header
   - Validates signature using configured secret and checks expiry/claims (HS256)
   - Requires claims: `sub` (user ID), `exp` (expiry), `iat` (issued-at) [optional `iss`]
   - On success, attaches the authenticated user ID (from `sub`) and claims to request context
   - On failure, returns `401` with a structured error per error handling strategy
   [Source: docs/architecture/backend-architecture.md#middleware-stack] [Source: docs/architecture/backend-architecture.md#configuration-management] [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]
2. Apply the middleware to protected routes in the router setup (users, coffees write, brewlogs, ai). [Source: apps/backend/internal/api/routes/routes.go]
3. Requests to protected routes without a valid token receive `401` and a consistent error body. Example error body:
   ```json
   {"code":"AUTHENTICATION_ERROR","message":"Invalid or missing authentication token"}
   ```
   [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]
4. Valid tokens allow access; downstream handlers can retrieve user identity from context. Use a dedicated context key type to avoid collisions. [Source: docs/architecture/backend-architecture.md#middleware-stack]
5. Token validation should allow small clock skew (e.g., 60s leeway) when checking `exp`/`iat` to reduce false negatives. [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]

## Tasks / Subtasks
- [x] Middleware Implementation (AC: 1, 4, 5)
  - [x] Implement `AuthMiddleware(jwtSecret string)` in `apps/backend/internal/api/middleware/middleware.go` to:
    - [x] Parse `Authorization` header, validate `Bearer` format
    - [x] Verify JWT using HS256 and `cfg.JWT.Secret`; validate `exp`/`iat` with small leeway
    - [x] Extract `sub` as user ID; set in `context.Context` using a dedicated context key type
    - [x] On error, respond with 401 using structured API error
    [Source: docs/architecture/backend-architecture.md#middleware-stack] [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]
- [x] Context Utilities (AC: 4)
  - [x] Add helper to read user ID/claims from context in handlers (new file if needed, e.g., `apps/backend/internal/api/middleware/auth_context.go`) [Source: docs/architecture/backend-architecture.md#middleware-stack]
- [x] Router Wiring (AC: 2)
  - [x] Ensure `protected.Use(middleware.AuthMiddleware(cfg.JWT.Secret))` remains applied to protected subrouter in `apps/backend/internal/api/routes/routes.go` [Source: apps/backend/internal/api/routes/routes.go]
- [x] Config Documentation (AC: 1)
  - [x] Confirm secret is loaded from env var `JWT_SECRET` and expiry from `JWT_EXPIRY` (see `apps/backend/internal/config/config.go`) and note defaults for dev [Source: apps/backend/internal/config/config.go]
- [x] Tests (AC: 1, 3, 4, 5)
  - [x] Unit test middleware: missing header → 401; malformed token → 401; expired token → 401; valid token → next handler called and context populated [Source: docs/architecture/development-workflow.md#backend-testing]
  - [x] Integration test: sample protected endpoint returns 200 with valid token, 401 without/invalid token [Source: docs/architecture/development-workflow.md#backend-testing]

## Dev Notes
The following guidance is extracted from architecture docs; no assumptions beyond cited sources.

### Dependencies
- Depends on Story 1.4 for token issuance during login. [Source: docs/stories/1.4.story.md]

### Backend Architecture & Organization
- Middleware stack includes authentication; config provides `JWT` secret via `cfg.JWT.Secret` with env var `JWT_SECRET`. Expiry configured via `JWT_EXPIRY`. Implement in `apps/backend/internal/api/middleware/middleware.go` and apply in router. [Source: docs/architecture/backend-architecture.md#middleware-stack] [Source: apps/backend/internal/config/config.go]
- Use structured errors for consistent `401` responses. [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]

### API Specifications
- Protected resources include `GET/PUT/DELETE /users/me`, coffee write endpoints, brew log endpoints, and AI endpoints. [Source: docs/architecture/api-specification.md#user--authentication-endpoints]

### File Locations / Project Structure
- Middleware: `apps/backend/internal/api/middleware/middleware.go`
- Routes: `apps/backend/internal/api/routes/routes.go`
- Optional context helpers: `apps/backend/internal/api/middleware/auth_context.go` (if added)
[Source: docs/architecture/backend-architecture.md#go-package-structure]

### Testing Requirements
- Backend tests should cover positive/negative paths for JWT verification and context propagation. [Source: docs/architecture/development-workflow.md#backend-testing]

### Technical Constraints
- Go 1.22.x, standard library + a minimal JWT library if already chosen; otherwise follow architecture guidance and consistent dependency policy. [Source: docs/architecture/tech-stack.md#technology-stack-table]

## Testing
- Unit tests for middleware on header parsing, verification, expiry (with leeway), and context injection. [Source: docs/architecture/development-workflow.md#backend-testing]
- Integration tests hitting protected routes with and without valid tokens. [Source: docs/architecture/development-workflow.md#backend-testing]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.2 | Added JWT alg/claims, config/env details, example 401 body, context key guidance, and expiry leeway | Scrum Master |
| {{DATE}} | 0.1 | Initial draft created for Story 1.6 | Scrum Master |
| 2025-08-21 | 1.0 | Implemented JWT auth middleware, context helpers, structured errors, and tests | Dev Agent |

## Dev Agent Record
### Agent Model Used
OpenAI Dev Agent (James) — local CLI

### Debug Log References
- Auth middleware unit + integration tests: apps/backend/internal/api/middleware/middleware_test.go
- Ran targeted `go test` for middleware package (passed)

### Completion Notes List
- Implemented HS256 JWT validation with 60s leeway for exp/iat
- Added structured 401 error body with code AUTHENTICATION_ERROR
- Injected user ID from `sub` and full claims into request context via helpers
- Confirmed router applies middleware to protected routes
- Confirmed config loads `JWT_SECRET` and `JWT_EXPIRY` with sensible defaults
- Added unit and integration tests for positive/negative paths

### File List
- apps/backend/internal/api/middleware/middleware.go (updated)
- apps/backend/internal/api/middleware/auth_context.go (new)
- apps/backend/internal/utils/jwt.go (updated)
- apps/backend/internal/api/middleware/middleware_test.go (new)

## QA Results
_To be completed by QA Agent_
