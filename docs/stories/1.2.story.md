# Story 1.2: Database Setup & User Model

## Status
Approved

## Story
As a developer, I want to set up the SQLite database connection and introduce versioned migrations for the `users` table, so that user information can be stored and schema changes can be applied and rolled back reliably.

## Acceptance Criteria
1. The Go backend can connect to a SQLite database file.
2. A database migration tool is added to the project.
3. A new migration is created for the `users` table with columns for `id`, `email`, `password_hash`, etc.
4. The migration can be applied and rolled back successfully.

## Tasks / Subtasks
- [ ] Implement SQLite connection (AC: 1)
  - [ ] Ensure `apps/backend/internal/database/connection.go` initializes SQLite with WAL and foreign keys enabled [Source: docs/architecture/backend-architecture.md#database-integration]
  - [ ] Confirm database file path and migrations path are configurable via `config.Database` (`DATABASE_URL`, `DATABASE_MIGRATIONS_PATH`) [Source: docs/architecture/backend-architecture.md#configuration-management]
- [ ] Introduce versioned migrations runner (AC: 2, 4)
  - [ ] Add a simple migration runner under `apps/backend/cmd/migrate` to execute `*.up.sql` and `*.down.sql` in order, tracking versions in a `schema_migrations` table [Source: docs/architecture/backend-architecture.md#migration-strategy]
  - [ ] Provide commands: `migrate up` (to latest), `migrate down` (one step), and `migrate to <version>` [Source: docs/architecture/backend-architecture.md#migration-strategy]
  - [ ] Update `Makefile` with `db-migrate-up` and `db-migrate-down` targets [Source: docs/architecture/development-workflow.md#development-process]
- [ ] Create initial `users` table migration (AC: 3)
  - [ ] Add `apps/backend/migrations/001_users_table.up.sql` implementing the `users` schema per architecture [Source: docs/architecture/database-schema.md#sqlite-schema-definition]
  - [ ] Add `apps/backend/migrations/001_users_table.down.sql` to drop the table and associated indexes/triggers [Source: docs/architecture/backend-architecture.md#migration-strategy]
- [ ] Apply and verify migration (AC: 4)
  - [ ] Run `migrate up` locally to create `users`
  - [ ] Add a database test using in-memory SQLite to run `up` then `down`, verifying table presence/absence [Source: docs/architecture/development-workflow.md#database-testing]
- [ ] Documentation
  - [ ] Add brief usage notes to `README.md` for migration commands [Source: docs/architecture/development-workflow.md#development-process]

## Dev Notes
The following guidance is extracted only from architecture documents and existing repo structure.

### Previous Story Insights
- Story 1.1 established the monorepo, React + Vite frontend, Go backend, health endpoint, and basic CI. This story builds on that foundation by enabling persistent storage and schema management.

### Data Models
- User model fields and constraints to reflect in schema: `ID`, `Username`, `Email` (unique), `PasswordHash`, `PasswordSalt`, `CreatedAt`, `UpdatedAt`. [Source: docs/architecture/data-models.md#user-model]

### Database Schema
- SQLite schema for `users` is defined, including unique indexes for `email` and `username`, timestamp columns, and an `updated_at` trigger. Use these definitions for the migration SQL. [Source: docs/architecture/database-schema.md#sqlite-schema-definition]
- Data integrity constraints: uniqueness on username/email; enforce via indexes in migration. [Source: docs/architecture/database-schema.md#data-integrity-constraints]

### Backend Integration
- Use SQLite 3.x for the MVP; Go 1.22 with the standard library. [Source: docs/architecture/tech-stack.md#technology-stack-table]
- Database integration emphasizes connection pooling, transactions, and enabling foreign keys; WAL mode recommended. [Source: docs/architecture/backend-architecture.md#database-integration]
- Migration strategy requires version-controlled schema changes and rollback capabilities; implement a runner to execute up/down SQL files. [Source: docs/architecture/backend-architecture.md#migration-strategy]

### API Specifications
- No new API endpoints are required for this story; database setup is internal. Future auth/user endpoints are defined elsewhere. [Source: docs/architecture/api-specification.md#user--authentication-endpoints]

### File Locations / Project Structure
- Monorepo layout and backend folder locations: `apps/backend/{cmd,internal,migrations}`. [Source: docs/architecture/source-tree.md#monorepo-organization]
- Relevant files and paths in this repo: `apps/backend/internal/database/connection.go`, `apps/backend/cmd/setup/main.go`, `apps/backend/migrations/`. Ensure new migration runner lives under `apps/backend/cmd/migrate`. [Source: docs/architecture/backend-architecture.md#go-package-structure]

### Testing Requirements
- Follow the testing pyramid; implement database tests using in-memory SQLite and migration runner. [Source: docs/architecture/development-workflow.md#testing-pyramid] [Source: docs/architecture/development-workflow.md#database-testing]
- Backend unit/integration tests via Go `testing`. [Source: docs/architecture/development-workflow.md#backend-testing]

### Technical Constraints
- Tech stack: Go 1.22.x, SQLite 3.x, REST backend with `net/http`. [Source: docs/architecture/tech-stack.md#technology-stack-table]
- Config-driven database URL and migrations path; expose via environment variables. [Source: docs/architecture/backend-architecture.md#configuration-management]

### Project Structure Notes
- The architecture prescribes a migration strategy (versioned with rollback). The repo currently includes a one-off setup program that executes a single SQL file; extend to a versioned up/down runner to align with architecture. [Source: docs/architecture/backend-architecture.md#migration-strategy]

## Testing
- Add Go tests to validate `migrate up` creates `users` and `migrate down` removes it using an in-memory SQLite database. [Source: docs/architecture/development-workflow.md#database-testing]
- Ensure connection settings enable `PRAGMA foreign_keys = ON` and `PRAGMA journal_mode = WAL` before running migrations. [Source: docs/architecture/backend-architecture.md#database-integration]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.1 | Initial draft created for Story 1.2 | Scrum Master |

## Dev Agent Record
### Agent Model Used
James (dev) — Implemented migration runner and users migration

### Debug Log References
No debug log file present (expected .ai/debug-log.md)

### Completion Notes List
- Added versioned migration runner with up/down/to commands and tracking table
- Created users table migrations with indexes and updated_at trigger
- Added migration tests covering up and down on a temp SQLite database
- Exposed CLI at apps/backend/cmd/migrate and Makefile targets for convenience
- Updated README with migration usage (make db-migrate-up/down)

### File List
- apps/backend/internal/migrate/runner.go (added)
- apps/backend/cmd/migrate/main.go (added)
- apps/backend/migrations/001_users_table.up.sql (added)
- apps/backend/migrations/001_users_table.down.sql (added)
- apps/backend/internal/migrate/runner_test.go (added)
- Makefile (updated)
- README.md (updated)

## QA Results
### Review Date: 2025-08-19

### Reviewed By: Quinn (Test Architect)

### Review Summary

- Scope: SQLite DB setup, versioned migration runner, `users` table migration with up/down, and migration tests.
- Depth: Deep review due to failing migration tests impacting core AC.

### Gate Decision

- Gate: FAIL
- Reason: Applying `001_users_table.up.sql` fails with "incomplete input" because the migration runner naively splits SQL by `;`, which breaks SQLite `CREATE TRIGGER ... BEGIN ... END;` blocks. As a result, AC4 (apply and rollback successfully) is not met.

### Requirements Traceability (AC → Evidence)

- AC1 (SQLite connection): ✓ `internal/database/connection.go` initializes SQLite, enables `foreign_keys` and `WAL`; used by tests.
- AC2 (Migration tool added): ✓ `internal/migrate/runner.go` with CLI at `cmd/migrate` supports `up`, `down`, `to`.
- AC3 (`users` migration created): ✓ `migrations/001_users_table.up.sql` and `.down.sql` present with table, indexes, trigger.
- AC4 (Apply and rollback successfully): ✗ `ApplyUpToLatest` fails on trigger due to naive SQL splitting; `runner_test.go` reports `incomplete input`.

### Code Quality Assessment

- Runner design (discover/order/track) is sound; error stems from SQL splitting strategy.
- Config surfaces `DATABASE_URL` and `DATABASE_MIGRATIONS_PATH` as required; good separation of concerns.
- Tests target correct behavior (up creates table; down drops table); they expose the runner limitation.

### Test Architecture Assessment

- Positive: Uses temp DB per test; verifies presence via `sqlite_master`.
- Gap: Runner should execute compound statements atomically without naive tokenization. Consider executing whole script or a smarter splitter aware of `BEGIN...END` blocks/comments/strings.

### Improvements Checklist

- [ ] Fix `splitSQLStatements` to accumulate statements within `BEGIN ... END` blocks and avoid splitting inside trigger bodies; or do not split at all for sqlite3 (driver accepts multiple statements separated by `;`).
- [ ] Add tests for migrations containing triggers and multi-statement scripts to prevent regressions.
- [ ] Normalize migrations naming (use only `.up.sql`/`.down.sql`); remove or convert stray `001_initial_schema.sql`.
- [ ] Ensure `cmd/migrate up` and `down` paths are covered in CI after the fix.

### Security Review

- No auth flows introduced; no sensitive data handling in scope. No issues identified.

### Performance Considerations

- Not applicable at this layer; runner executes quickly on SQLite. No concerns.

### Files Modified During Review

- None (advisory only in this review).

### Gate Status

Gate: FAIL → docs/qa/gates/1.2-database-setup-user-model.yml
Risk profile: docs/qa/assessments/1.2-risk-20250819.md
NFR assessment: docs/qa/assessments/1.2-nfr-20250819.md

### Recommended Status

✗ Changes Required — fix migration runner splitting and verify tests pass.
