# Story 1.8: Auth Persistence & Token Expiry UX

## Status
Draft

## Story
As a returning user, I want my session to persist across refreshes and to be clearly signed out when my token expires, so that the app behaves predictably and securely.

## Acceptance Criteria
1. Persisted session bootstrap:
   - On app start, if `localStorage['authToken']` exists, the app sets the Authorization header and requests `/api/v1/users/me` to hydrate the session.
   - Success: user is set and the app renders authenticated UI.
   - Failure (401/invalid): token is cleared, user is unset, and the app redirects to `/login`.
   [Source: docs/architecture/frontend-architecture.md#state-persistence] [Source: docs/stories/1.7.story.md]
2. Token expiry handling:
   - If any authenticated API request returns 401 due to an expired/invalid token, the app automatically logs the user out (clears token, resets state) and redirects to `/login`.
   - A brief, non-intrusive notification (e.g., toast) informs the user that the session expired, using the existing `ToastNotifications` mechanism with `data-testid="session-expired-toast"` for testability.
   [Source: docs/architecture/frontend-architecture.md#route-guards] [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
3. No refresh tokens for MVP:
   - Do not implement token refresh. Users must re-login when the token expires.
   - Document this constraint in Dev Notes.
4. Consistent UI states:
   - Header updates immediately on bootstrap and on expiry-triggered logout (e.g., `Logout` visibility toggles via `isAuthenticated`).
   - Protected routes are inaccessible without a valid session; navigation attempts redirect to `/login`.
   - During initial bootstrap, protected routes display a lightweight loading state to avoid flicker until auth is determined.
   [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy] [Source: docs/architecture/frontend-architecture.md#route-guards]

## Tasks / Subtasks
- [ ] Frontend: Bootstrap flow (AC: 1, 4)
  - [ ] In `apps/frontend/src/context/AuthContext.tsx`, on mount read `localStorage['authToken']`; if present, set API header and call `/api/v1/users/me`.
  - [ ] Introduce `isBootstrapping` flag in `AuthContext` that is true during the initial hydration request; set to false once resolved (success or 401).
  - [ ] On success, set `user` and `isAuthenticated=true`; on 401, clear token, reset state, redirect to `/login` via centralized `logout()`.
  [Source: docs/stories/1.7.story.md] [Source: docs/architecture/frontend-architecture.md#state-persistence]
- [ ] Frontend: Axios instance & interceptors (AC: 2)
  - [ ] In `apps/frontend/src/utils/api.ts`, ensure a single Axios instance injects `Authorization` header when token present.
  - [ ] Add a response interceptor to catch 401; trigger `logout()` and show a toast "Session expired. Please sign in again." with `data-testid="session-expired-toast"` (integrate with `ToastNotifications` or simple fallback).
  - [ ] Ensure idempotent handling for concurrent 401s (e.g., guard flag) to avoid multiple logout calls and duplicate toasts.
  [Source: docs/architecture/frontend-architecture.md#route-guards] [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
- [ ] Frontend: ProtectedRoute (AC: 4)
  - [ ] Ensure/implement `ProtectedRoute` wrapper that checks `isAuthenticated` and redirects to `/login` if false.
  - [ ] While `isBootstrapping` is true, render a minimal loader in protected routes instead of redirecting to avoid flicker.
  [Source: docs/architecture/frontend-architecture.md#route-guards]
- [ ] Frontend: Header UX (AC: 4)
  - [ ] Update `apps/frontend/src/components/Header.tsx` to use `useAuth()` and conditionally render `Logout` (with `data-testid="logout-button"`).
  - [ ] Ensure state reflects bootstrap and expiry transitions.
  [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
- [ ] Frontend: Centralize redirect behavior (AC: 2)
  - [ ] Ensure `logout()` is responsible for clearing token, resetting state, showing the expiry toast (when applicable), and navigating to `/login` so behavior is consistent across interceptor and UI-initiated logouts.
  [Source: docs/stories/1.5.story.md]
- [ ] Tests (AC: 1, 2, 4)
  - [ ] Hydration success test: with token, `/users/me` resolves → `user` set, `isAuthenticated=true`, `Logout` visible; assert `Authorization: Bearer <token>` header was sent.
  - [ ] Hydration failure test: with invalid token, `/users/me` 401 → token cleared, redirect to `/login`, `session-expired-toast` shown.
  - [ ] Interceptor test: any API call 401 → `logout()` invoked, redirect to `/login`, single `session-expired-toast` shown even with concurrent 401s.
  - [ ] ProtectedRoute test: unauthenticated navigation redirects to `/login`; while `isBootstrapping`, a loader is shown instead of redirecting.
  [Source: docs/architecture/development-workflow.md#frontend-testing]

## Dev Notes
The following guidance is extracted from architecture and prior stories; no assumptions beyond cited sources.

### Dependencies
- Depends on Story 1.5 (Logout behavior and Axios 401 auto-logout).
- Depends on Story 1.7 (Hydration via `/users/me`).
  [Source: docs/stories/1.5.story.md] [Source: docs/stories/1.7.story.md]

### Technical Constraints & Decisions
- MVP explicitly does not implement token refresh. Session expiry results in logout and a user prompt to sign in again.
- Token key standardized as `authToken` (migrate from any legacy `token` uses).
  [Source: docs/stories/1.5.story.md]

### Bootstrap Loading State
- Add `isBootstrapping` to `AuthContext` to gate protected route behavior and avoid flicker on initial load; show a minimal loader until auth is determined.

### Idempotent 401 Handling
- Use a simple guard (e.g., `isLoggingOutRef`) around interceptor-driven logout to ensure only one logout and one toast are triggered across concurrent 401 responses.

### File Locations / Project Structure
- Frontend: `apps/frontend/src/context/AuthContext.tsx`, `apps/frontend/src/utils/api.ts`, `apps/frontend/src/components/Header.tsx`, `apps/frontend/src/App.tsx` (or router file) for `ProtectedRoute`.
  [Source: docs/architecture/source-tree.md#monorepo-organization]

## Testing
- Frontend tests cover hydration success/failure, 401 interceptor logout, ProtectedRoute behavior, and UI/notification states; use `data-testid` for stable selectors and assert Authorization header presence where applicable.
  [Source: docs/architecture/development-workflow.md#frontend-testing]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.2 | Added toast mechanism + test id, centralized redirect in logout(), bootstrap loading flag, idempotent 401 handling, and expanded test assertions | Scrum Master |
| {{DATE}} | 0.1 | Initial draft created for Story 1.8 | Scrum Master |

## Dev Agent Record
### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be completed by QA Agent_
