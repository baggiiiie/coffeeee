# Story 1.8: Auth Persistence & Token Expiry UX

## Status
Ready for Review

## Story
As a returning user, I want my session to persist across refreshes and to be clearly signed out when my token expires, so that the app behaves predictably and securely.

## Acceptance Criteria
1. Persisted session bootstrap:
   - On app start, if `localStorage['authToken']` exists, the app sets the Authorization header and requests `/api/v1/users/me` to hydrate the session.
   - Success: user is set and the app renders authenticated UI.
   - Failure (401/invalid): token is cleared, user is unset, and the app redirects to `/login`.
   [Source: docs/architecture/frontend-architecture.md#state-persistence] [Source: docs/stories/1.7.story.md]
2. Token expiry handling:
   - If any authenticated API request returns 401 due to an expired/invalid token, the app automatically logs the user out (clears token, resets state) and redirects to `/login`.
   - A brief, non-intrusive notification (e.g., toast) informs the user that the session expired, using the existing `ToastNotifications` mechanism with `data-testid="session-expired-toast"` for testability.
   [Source: docs/architecture/frontend-architecture.md#route-guards] [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
3. No refresh tokens for MVP:
   - Do not implement token refresh. Users must re-login when the token expires.
   - Document this constraint in Dev Notes.
4. Consistent UI states:
   - Header updates immediately on bootstrap and on expiry-triggered logout (e.g., `Logout` visibility toggles via `isAuthenticated`).
   - Protected routes are inaccessible without a valid session; navigation attempts redirect to `/login`.
   - During initial bootstrap, protected routes display a lightweight loading state to avoid flicker until auth is determined.
   [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy] [Source: docs/architecture/frontend-architecture.md#route-guards]

## Tasks / Subtasks
- [x] Frontend: Bootstrap flow (AC: 1, 4)
  - [x] In `apps/frontend/src/context/AuthContext.tsx`, on mount read `localStorage['authToken']`; if present, set API header and call `/api/v1/users/me`.
  - [x] Introduce `isBootstrapping` flag in `AuthContext` that is true during the initial hydration request; set to false once resolved (success or 401).
  - [x] On success, set `user` and `isAuthenticated=true`; on 401, clear token, reset state, redirect to `/login` via centralized `logout()`.
  [Source: docs/stories/1.7.story.md] [Source: docs/architecture/frontend-architecture.md#state-persistence]
- [x] Frontend: Axios instance & interceptors (AC: 2)
  - [x] In `apps/frontend/src/utils/api.ts`, ensure a single Axios instance injects `Authorization` header when token present.
  - [x] Add a response interceptor to catch 401; trigger `logout()` and show a toast "Session expired. Please sign in again." with `data-testid="session-expired-toast"` (integrate with `ToastNotifications` or simple fallback).
  - [x] Ensure idempotent handling for concurrent 401s (e.g., guard flag) to avoid multiple logout calls and duplicate toasts.
  [Source: docs/architecture/frontend-architecture.md#route-guards] [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
- [x] Frontend: ProtectedRoute (AC: 4)
  - [x] Ensure/implement `ProtectedRoute` wrapper that checks `isAuthenticated` and redirects to `/login` if false.
  - [x] While `isBootstrapping` is true, render a minimal loader in protected routes instead of redirecting to avoid flicker.
  [Source: docs/architecture/frontend-architecture.md#route-guards]
- [x] Frontend: Header UX (AC: 4)
  - [x] Update `apps/frontend/src/components/Header.tsx` to use `useAuth()` and conditionally render `Logout` (with `data-testid="logout-button"`).
  - [x] Ensure state reflects bootstrap and expiry transitions.
  [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
- [x] Frontend: Centralize redirect behavior (AC: 2)
  - [x] Ensure `logout()` is responsible for clearing token, resetting state, showing the expiry toast (when applicable), and navigating to `/login` so behavior is consistent across interceptor and UI-initiated logouts.
  [Source: docs/stories/1.5.story.md]
- [x] Tests (AC: 1, 2, 4)
  - [x] Hydration success test: with token, `/users/me` resolves → `user` set, `isAuthenticated=true`, `Logout` visible.
  - [x] Hydration failure test: with invalid token, `/users/me` 401 → token cleared, redirect to `/login`, `session-expired-toast` shown.
  - [x] Interceptor test: any API call 401 → `logout()` invoked, redirect to `/login`, single `session-expired-toast` shown even with concurrent 401s.
  - [x] ProtectedRoute test: unauthenticated navigation redirects to `/login`; while `isBootstrapping`, a loader is shown instead of redirecting.
  [Source: docs/architecture/development-workflow.md#frontend-testing]

## Dev Notes
The following guidance is extracted from architecture and prior stories; no assumptions beyond cited sources.

### Dependencies
- Depends on Story 1.5 (Logout behavior and Axios 401 auto-logout).
- Depends on Story 1.7 (Hydration via `/users/me`).
  [Source: docs/stories/1.5.story.md] [Source: docs/stories/1.7.story.md]

### Technical Constraints & Decisions
- MVP explicitly does not implement token refresh. Session expiry results in logout and a user prompt to sign in again.
- Token key standardized as `authToken` (migrate from any legacy `token` uses).
  [Source: docs/stories/1.5.story.md]

### Bootstrap Loading State
- Add `isBootstrapping` to `AuthContext` to gate protected route behavior and avoid flicker on initial load; show a minimal loader until auth is determined.

### Idempotent 401 Handling
- Use a simple guard (e.g., `isLoggingOutRef`) around interceptor-driven logout to ensure only one logout and one toast are triggered across concurrent 401 responses.

### File Locations / Project Structure
- Frontend: `apps/frontend/src/context/AuthContext.tsx`, `apps/frontend/src/utils/api.ts`, `apps/frontend/src/components/Header.tsx`, `apps/frontend/src/App.tsx` (or router file) for `ProtectedRoute`.
  [Source: docs/architecture/source-tree.md#monorepo-organization]

## Testing
- Frontend tests cover hydration success/failure, 401 interceptor logout, ProtectedRoute behavior, and UI/notification states; use `data-testid` for stable selectors and assert Authorization header presence where applicable.
  [Source: docs/architecture/development-workflow.md#frontend-testing]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-08-21 | 1.0 | Implemented Story 1.8 frontend (bootstrap, 401 handling with toast, ProtectedRoute loader) and tests; set status Ready for Review | Dev Agent |
| {{DATE}} | 0.2 | Added toast mechanism + test id, centralized redirect in logout(), bootstrap loading flag, idempotent 401 handling, and expanded test assertions | Scrum Master |
| {{DATE}} | 0.1 | Initial draft created for Story 1.8 | Scrum Master |

## Dev Agent Record
### Agent Model Used
OpenAI Codex CLI Dev Agent

### Debug Log References
- Frontend tests: `apps/frontend/src/AuthPersistence.test.tsx`
- Frontend tests updated: `apps/frontend/src/context/AuthContext.test.tsx`

### Completion Notes List
- Implemented auth bootstrap with `isBootstrapping` flag and user hydration.
- Added Axios 401 interceptor with idempotent logout guard and session-expiry toast.
- Centralized logout behavior to clear state, show toast, and redirect.
- ProtectedRoute now renders loader while bootstrapping to prevent flicker.
- Added and updated tests; all frontend tests pass locally.

### File List
- Modified: `apps/frontend/src/utils/api.ts`
- Modified: `apps/frontend/src/context/AuthContext.tsx`
- Modified: `apps/frontend/src/components/ProtectedRoute.tsx`
- Added: `apps/frontend/src/AuthPersistence.test.tsx`
- Modified: `apps/frontend/src/context/AuthContext.test.tsx`

## QA Results
_To be completed by QA Agent_
