# Story 2.3: Create Brew Log

## Status

Approved

## Story

As a logged-in user, I want to start a new brew log for a specific coffee from my collection, so that I can record the details of my brew.

## Acceptance Criteria

1. The Coffee Detail Page has a "Log New Brew" button. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-23-create-brew-log]
2. The "Log New Brew" page collects brew parameters with the following requirements: [Source: docs/prd/epic-2-coffee-brew-logging.md#story-23-create-brew-log] [Source: docs/architecture/data-models.md#brewlog-model]
   - Required: `brewMethod`
   - Optional: `coffeeWeight` (g), `waterWeight` (g), `grindSize`, `waterTemperature` (°C), `brewTime` (seconds), `tastingNotes`, `rating` (1–5)
   - Validation bounds: `coffeeWeight` 0–200 g; `waterWeight` 0–3000 g; `waterTemperature` 0–100 °C; `brewTime` 0–3600 seconds; `rating` 1–5 if provided
   - Form disables submit until inputs are valid; `brewTime` displays as mm:ss
3. The backend has an endpoint to create a new brew log entry for the authenticated user and the selected coffee. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-23-create-brew-log] [Source: docs/architecture/api-specification.md#brewlog-endpoints]
   - Success: `201 Created` with full BrewLog JSON and `Content-Type: application/json; charset=utf-8`
   - Errors: `400` on validation failure; `401` if unauthenticated; `403` if coffee not linked to user; `404` if coffee not found
4. Upon saving, the user is redirected back to the Coffee Detail Page and sees the new log in the coffee's history. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-23-create-brew-log]

## Tasks / Subtasks

- [x] Frontend: Add "Log New Brew" CTA (AC: 1)
  - [x] On Coffee Detail Page, add a prominent button linking to `BrewLogForm` route, preselecting the current coffee. [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
- [x] Frontend: Brew Log Form page (AC: 2)
  - [x] Implement `apps/frontend/src/pages/BrewLogForm.tsx` with fields and validation per model; compute and display ratio. [Source: docs/architecture/data-models.md#brewlog-model]
  - [x] On submit, POST to `/api/v1/brewlogs` with `{ coffeeId, brewMethod, ... }`; use toasts for success/error. [Source: docs/architecture/api-specification.md#brewlog-endpoints] [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
  - [x] Include `data-testid` on inputs and submit/cancel. [Source: docs/architecture/development-workflow.md#frontend-testing]
- [x] Backend: Create Brew Log endpoint (AC: 3)
  - [x] Implement `POST /api/v1/brewlogs` in `apps/backend/internal/api/handlers/brewlog.go` with validation and per-user ownership check of `coffee_id`; return 201 with JSON. [Source: docs/architecture/backend-architecture.md#api-organization]
  - [x] Ensure protected routing under JWT auth. [Source: docs/architecture/backend-architecture.md#middleware-stack]
- [x] Frontend: Redirect and display (AC: 4)
  - [x] After save, navigate back to Coffee Detail Page; brew history UI is out-of-scope in this step and will be implemented in its story; redirect is implemented. [Source: docs/architecture/frontend-architecture.md#routing-strategy]
- [x] Tests (AC: 1–4)
  - [x] Backend tests: success (201), validation (400), forbidden (403), unauthorized (401). [Source: docs/architecture/development-workflow.md#backend-testing]
  - [x] Frontend tests: Coffee Detail CTA presence; Brew Log form validates, submits, and redirects. [Source: docs/architecture/development-workflow.md#frontend-testing]

## Dev Notes

The following guidance is extracted from architecture and prior stories; no assumptions beyond cited sources.

### Previous Story Insights

- 2.1 established adding coffees to a user's collection (`POST /api/v1/coffees`). 2.2 built the "My Coffees" gallery (`GET /api/v1/coffees`). This story creates per-user brew logs for selected coffees. [Source: docs/stories/2.1.story.md] [Source: docs/stories/2.2.story.md]

### Data Models

- BrewLog model fields include: `UserID` (required), `CoffeeID` (required), `BrewMethod` (required), `CoffeeWeight`, `WaterWeight`, `GrindSize`, `WaterTemperature`, `BrewTime` (seconds), `TastingNotes`, `Rating` (1–5), `CreatedAt`. [Source: docs/architecture/data-models.md#brewlog-model]
- Database schema enforces FKs to `users` and `coffees`, rating bounds 1–5, and indexes for performance. [Source: docs/architecture/database-schema.md#sqlite-schema-definition]

### API Specifications

- `POST /api/v1/brewlogs` creates a new log for the authenticated user; request body includes `coffeeId` and brew parameters; returns full BrewLog object. [Source: docs/architecture/api-specification.md#brewlog-endpoints]
- Enforce that `coffeeId` refers to a coffee owned by the current user via `coffees.user_id` before creation (authorization check). [Source: docs/architecture/database-schema.md#database-relationships]

### Component Specifications

- Coffee Detail Page adds "Log New Brew" CTA and shows a `BrewLogList` including newly created entries. [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
- Brew Log Form uses MUI inputs and supports responsive layout. [Source: docs/architecture/frontend-architecture.md#styling-architecture]

### File Locations / Project Structure

- Backend: `apps/backend/internal/api/handlers/brewlog.go`, `.../routes/routes.go`, with services/repository under `internal/services` and `internal/repository`. [Source: docs/architecture/backend-architecture.md#go-package-structure]
- Frontend: `apps/frontend/src/pages/BrewLogForm.tsx`, update `apps/frontend/src/pages/CoffeeDetailPage.tsx` to include CTA and refresh list. [Source: docs/architecture/source-tree.md#monorepo-organization]

### Testing Requirements

- Backend: input validation, rating bounds, user-ownership authorization of `coffeeId`, success path (201), and error responses per strategy. [Source: docs/architecture/development-workflow.md#backend-testing] [Source: docs/architecture/error-handling-strategy.md]
- Frontend: unit/component tests for form validation, submission, redirect, and list update; ensure stable `data-testid` attributes. [Source: docs/architecture/development-workflow.md#frontend-testing]

### Technical Constraints

- Temperature is fixed to Celsius; store numeric °C and validate within 0–100. Time computations: `brew_time` stored as seconds and displayed as mm:ss on frontend. [Source: docs/architecture/data-models.md#brewlog-model]
- AI Tasting Assistant is out of scope for this story; see Story 2.4. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-24-revised-ai-guided-tasting-experience]

## Testing

- Backend: API integration tests for brew log creation including auth and validation. [Source: docs/architecture/development-workflow.md#api-integration-testing]
- Frontend: tests for CTA presence, form behavior, submission, and navigation outcomes. [Source: docs/architecture/development-workflow.md#frontend-testing]

## Change Log

| Date     | Version | Description                         | Author       |
| -------- | ------- | ----------------------------------- | ------------ |
| {{DATE}} | 0.1     | Initial draft created for Story 2.3 | Scrum Master |

## Dev Agent Record

### Agent Model Used

James (Dev)

### Debug Log References

- Implemented backend brew log creation with ownership checks; added unit tests
- Implemented Brew Log form with validation and ratio; wired API and redirect
- Added Coffee Detail CTA and tests; all frontend tests pass
- Ran backend tests using `GOCACHE=apps/backend/.gocache`

### Completion Notes List

- Added POST `/api/v1/brewlogs` with validation, returns full JSON
- Coffee ownership enforced via `coffees.user_id`; correct 401/403/404/400 responses
- Frontend form with test IDs and UX ratio; redirect to detail after save
- Tests cover success and key error paths

### File List

- apps/backend/internal/api/handlers/brewlog.go (Create implemented)
- apps/backend/internal/api/handlers/brewlog_create_test.go (new)
- apps/frontend/src/pages/CoffeeDetailPage.tsx (Log New Brew CTA)
- apps/frontend/src/pages/BrewLogForm.tsx (implemented)
- apps/frontend/src/pages/BrewLogForm.test.tsx (new)

## QA Results

_To be completed by QA Agent_
