# Story 2.3: Create Brew Log

## Status
Draft

## Story
As a logged-in user, I want to start a new brew log for a specific coffee from my collection, so that I can record the details of my brew.

## Acceptance Criteria
1. The Coffee Detail Page has a "Log New Brew" button. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-23-create-brew-log]
2. The "Log New Brew" page collects brew parameters with the following requirements: [Source: docs/prd/epic-2-coffee-brew-logging.md#story-23-create-brew-log] [Source: docs/architecture/data-models.md#brewlog-model]
   - Required: `brewMethod`
   - Optional: `coffeeWeight` (g), `waterWeight` (g), `grindSize`, `waterTemperature` (°C), `brewTime` (seconds), `tastingNotes`, `rating` (1–5)
   - Validation bounds: `coffeeWeight` 0–200 g; `waterWeight` 0–3000 g; `waterTemperature` 0–100 °C; `brewTime` 0–3600 seconds; `rating` 1–5 if provided
   - Form disables submit until inputs are valid; `brewTime` displays as mm:ss
3. The backend has an endpoint to create a new brew log entry for the authenticated user and the selected coffee. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-23-create-brew-log] [Source: docs/architecture/api-specification.md#brewlog-endpoints]
   - Success: `201 Created` with full BrewLog JSON and `Content-Type: application/json; charset=utf-8`
   - Errors: `400` on validation failure; `401` if unauthenticated; `403` if coffee not linked to user; `404` if coffee not found
4. Upon saving, the user is redirected back to the Coffee Detail Page and sees the new log in the coffee's history. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-23-create-brew-log]

## Tasks / Subtasks
- [ ] Frontend: Add "Log New Brew" CTA (AC: 1)
  - [ ] On Coffee Detail Page, add a prominent button linking to `BrewLogForm` route, preselecting the current coffee. [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
- [ ] Frontend: Brew Log Form page (AC: 2)
  - [ ] Create `apps/frontend/src/pages/BrewLogForm.tsx` with fields: `brewMethod` (required), `coffeeWeight` (g), `waterWeight` (g), `grindSize`, `waterTemperature` (°C/°F), `brewTime` (seconds), `tastingNotes` (text), `rating` (1–5). [Source: docs/architecture/data-models.md#brewlog-model]
  - [ ] Validate required fields and numeric bounds: `coffeeWeight` 0–200 g, `waterWeight` 0–3000 g, `waterTemperature` 0–100 °C, `brewTime` 0–3600 s; `rating` 1–5 if provided; compute and display ratio from coffee/water weights for UX. [Source: docs/architecture/coding-standards.md]
  - [ ] On submit, POST to `/api/v1/brewlogs` with `{ coffeeId, brewMethod, ... }`; use toasts for success/error. [Source: docs/architecture/api-specification.md#brewlog-endpoints] [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
  - [ ] Include `data-testid` attributes on inputs and submit/cancel. [Source: docs/architecture/development-workflow.md#frontend-testing]
- [ ] Backend: Create Brew Log endpoint (AC: 3)
  - [ ] Implement `POST /api/v1/brewlogs` in `apps/backend/internal/api/handlers/brewlog.go` to create a log for the authenticated `user_id` and provided `coffee_id`. [Source: docs/architecture/backend-architecture.md#api-organization]
  - [ ] Validate input (required `brew_method`; bounds: `coffee_weight` 0–200, `water_weight` 0–3000, `water_temperature` 0–100 °C, `brew_time` 0–3600; `rating` 1–5 if present). Ensure `coffee_id` refers to an existing coffee linked to the user (per-user ownership). Return `201 Created` with full BrewLog JSON, or structured errors with correct status codes. [Source: docs/architecture/error-handling-strategy.md#backend-error-handling] [Source: docs/architecture/database-schema.md#database-relationships]
  - [ ] Route wiring under protected router with JWT auth. [Source: docs/architecture/backend-architecture.md#middleware-stack]
- [ ] Frontend: Redirect and display (AC: 4)
  - [ ] After successful save, navigate back to Coffee Detail Page and refresh its brew history list to include the new entry. [Source: docs/architecture/frontend-architecture.md#routing-strategy]
- [ ] Tests (AC: 1–4)
  - [ ] Backend integration tests: success path (201), validation errors (400), rating bounds, and authorization failures. [Source: docs/architecture/development-workflow.md#backend-testing]
  - [ ] Frontend tests: button presence on Coffee Detail, form validation, successful submission flow with redirect, and list update. [Source: docs/architecture/development-workflow.md#frontend-testing]

## Dev Notes
The following guidance is extracted from architecture and prior stories; no assumptions beyond cited sources.

### Previous Story Insights
- 2.1 established adding coffees to a user's collection (`POST /api/v1/users/me/coffees`). 2.2 built the "My Coffees" gallery (`GET /api/v1/users/me/coffees`). This story creates per-user brew logs for selected coffees. [Source: docs/stories/2.1.story.md] [Source: docs/stories/2.2.story.md]

### Data Models
- BrewLog model fields include: `UserID` (required), `CoffeeID` (required), `BrewMethod` (required), `CoffeeWeight`, `WaterWeight`, `GrindSize`, `WaterTemperature`, `BrewTime` (seconds), `TastingNotes`, `Rating` (1–5), `CreatedAt`. [Source: docs/architecture/data-models.md#brewlog-model]
- Database schema enforces FKs to `users` and `coffees`, rating bounds 1–5, and indexes for performance. [Source: docs/architecture/database-schema.md#sqlite-schema-definition]

### API Specifications
- `POST /api/v1/brewlogs` creates a new log for the authenticated user; request body includes `coffeeId` and brew parameters; returns full BrewLog object. [Source: docs/architecture/api-specification.md#brewlog-endpoints]
- Consider enforcing that `coffeeId` must be linked to the current user via `user_coffees` before creation (authorization check). [Source: docs/architecture/database-schema.md#database-relationships]

### Component Specifications
- Coffee Detail Page adds "Log New Brew" CTA and shows a `BrewLogList` including newly created entries. [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
- Brew Log Form uses MUI inputs and supports responsive layout. [Source: docs/architecture/frontend-architecture.md#styling-architecture]

### File Locations / Project Structure
- Backend: `apps/backend/internal/api/handlers/brewlog.go`, `.../routes/routes.go`, with services/repository under `internal/services` and `internal/repository`. [Source: docs/architecture/backend-architecture.md#go-package-structure]
- Frontend: `apps/frontend/src/pages/BrewLogForm.tsx`, update `apps/frontend/src/pages/CoffeeDetailPage.tsx` to include CTA and refresh list. [Source: docs/architecture/source-tree.md#monorepo-organization]

### Testing Requirements
- Backend: input validation, rating bounds, user-ownership authorization of `coffeeId`, success path (201), and error responses per strategy. [Source: docs/architecture/development-workflow.md#backend-testing] [Source: docs/architecture/error-handling-strategy.md]
- Frontend: unit/component tests for form validation, submission, redirect, and list update; ensure stable `data-testid` attributes. [Source: docs/architecture/development-workflow.md#frontend-testing]

### Technical Constraints
- Temperature is fixed to Celsius; store numeric °C and validate within 0–100. Time computations: `brew_time` stored as seconds and displayed as mm:ss on frontend. [Source: docs/architecture/data-models.md#brewlog-model]
- AI Tasting Assistant is out of scope for this story; see Story 2.4. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-24-revised-ai-guided-tasting-experience]

## Testing
- Backend: API integration tests for brew log creation including auth and validation. [Source: docs/architecture/development-workflow.md#api-integration-testing]
- Frontend: tests for CTA presence, form behavior, submission, and navigation outcomes. [Source: docs/architecture/development-workflow.md#frontend-testing]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.1 | Initial draft created for Story 2.3 | Scrum Master |

## Dev Agent Record
### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be completed by QA Agent_
