# Story 1.4: User Login & Authentication

## Status
Draft

## Story
As a registered user, I want to be able to log in to my account, so that I can access the application's features.

## Acceptance Criteria
1. The frontend has a login page.
2. The backend exposes a `/login` endpoint that authenticates the user.
3. Upon successful login, the backend returns a JWT (JSON Web Token).
4. The frontend stores the JWT securely and uses it for subsequent requests.
5. After logging in, the user is redirected to a simple, authenticated "dashboard" page.

## Tasks / Subtasks
- [ ] Frontend: Login page UI and flow (AC: 1, 5)
  - [ ] Implement `LoginPage` with email and password fields using MUI [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
  - [ ] On submit, call backend login endpoint and handle success/error states [Source: docs/architecture/frontend-architecture.md#routing-strategy]
  - [ ] On success, store JWT and redirect to `/dashboard` [Source: docs/architecture/frontend-architecture.md#routing-strategy]
- [ ] Frontend: Auth state and token storage (AC: 4)
  - [ ] Add `AuthContext` providing `login`, `logout`, and `isAuthenticated` using localStorage for the token [Source: docs/architecture/frontend-architecture.md#state-persistence]
  - [ ] Ensure protected routes require authentication, redirecting to `/login` when token absent/invalid [Source: docs/architecture/frontend-architecture.md#route-guards]
- [ ] Backend: Login endpoint (AC: 2, 3)
  - [ ] Implement `POST /api/v1/auth/login` handler in `internal/api/handlers/auth.go` to accept `{ email, password }` [Source: docs/architecture/backend-architecture.md#api-organization]
  - [ ] Lookup user by email and verify password using stored hash+salt utilities [Source: docs/architecture/data-models.md#user-model]
  - [ ] On success, generate JWT and return `{ token }`; on failure, return appropriate 401 error [Source: docs/architecture/backend-architecture.md#middleware-stack]
  - [ ] Wire route in `internal/api/routes/routes.go` under `/api/v1/auth/login` [Source: docs/architecture/backend-architecture.md#api-organization]
- [ ] Backend: JWT utilities and configuration (AC: 3)
  - [ ] Use `internal/utils/jwt.go` to sign tokens with configured secret, expiry [Source: docs/architecture/backend-architecture.md#configuration-management]
  - [ ] Ensure auth middleware validates JWT and sets user context for protected endpoints [Source: docs/architecture/backend-architecture.md#middleware-stack]
- [ ] Tests
  - [ ] Backend: Unit/integration tests for successful login, wrong password, unknown email [Source: docs/architecture/development-workflow.md#backend-testing]
  - [ ] Frontend: Component test for `LoginPage` submit flow and redirect (mock API) [Source: docs/architecture/development-workflow.md#frontend-testing]

## Dev Notes
The following guidance is extracted from architecture and PRD; no assumptions beyond cited sources.

### Previous Story Insights
- Story 1.3 adds user registration; login depends on users existing with securely stored password hashes and salts. Validate that registration flow is available or seed a test user for local testing. [Source: docs/stories/1.3.story.md]

### API Specifications
- Login endpoint defined as `POST /api/v1/auth/login` with body `{ "email", "password" }` returning `{ "token" }`. [Source: docs/architecture/api-specification.md#user--authentication-endpoints]
- PRD references `/login`; implement per API spec under `/api/v1/auth/login` and document the discrepancy; optionally alias if required. [Source: docs/prd/epic-1-foundation-user-onboarding.md]

### Data Models
- User includes `Email`, `PasswordHash`, `PasswordSalt`, timestamps. Login verifies provided password against stored hash/salt. [Source: docs/architecture/data-models.md#user-model]

### Backend Architecture
- Handlers under `internal/api/handlers` with routes in `internal/api/routes/routes.go`. Implement `AuthHandler.Login` and route `POST /api/v1/auth/login`. [Source: docs/architecture/backend-architecture.md#go-package-structure]
- Use password utilities in `internal/utils/password.go` to hash/verify passwords. [Source: docs/architecture/backend-architecture.md#go-package-structure]
- Generate JWT using `internal/utils/jwt.go` and configure via `Config.JWT` (secret, expiry). [Source: docs/architecture/backend-architecture.md#configuration-management]
- Authentication middleware validates JWT for protected routes and sets user context. [Source: docs/architecture/backend-architecture.md#middleware-stack]

### Frontend Architecture
- Provide `AuthContext` for authentication state and functions; store tokens in `localStorage`. [Source: docs/architecture/frontend-architecture.md#state-management-strategy]
- Public route `/login` renders `LoginPage`; on success redirect to `/dashboard`. [Source: docs/architecture/frontend-architecture.md#routing-strategy]
- Protected routes require `isAuthenticated`; redirect unauthenticated users to `/login`. [Source: docs/architecture/frontend-architecture.md#route-guards]

### File Locations / Project Structure
- Backend: `apps/backend/internal/api/handlers/auth.go`, `apps/backend/internal/api/routes/routes.go`, `apps/backend/internal/utils/jwt.go`, `apps/backend/internal/utils/password.go`, `apps/backend/internal/services/auth_service.go`, `apps/backend/internal/repository/user_repository.go`. [Source: docs/architecture/backend-architecture.md#go-package-structure]
- Frontend: `apps/frontend/src/pages/LoginPage.tsx`, `apps/frontend/src/context/AuthContext.tsx` (or similar), router setup in `App.tsx`. [Source: docs/architecture/source-tree.md#monorepo-organization]

### Testing Requirements
- Backend tests: authenticate valid user returns 200 with token; invalid credentials return 401; token contains expected claims (issuer, expiry) if specified. [Source: docs/architecture/development-workflow.md#backend-testing]
- Frontend tests: form validation, API call on submit, token stored, redirect to dashboard. [Source: docs/architecture/development-workflow.md#frontend-testing]

### Technical Constraints
- Tech stack: Go backend, JWT-based auth, React 18 + TypeScript frontend with tokens stored client-side. [Source: docs/architecture/tech-stack.md#technology-stack-table]

### Project Structure Notes
- Discrepancy: PRD uses `/login` while API spec uses `/api/v1/auth/login`. Implement API per spec; frontend route remains `/login`. Consider adding a backend alias `/api/v1/login` only if product requests parity with PRD wording. [Source: docs/architecture/api-specification.md#user--authentication-endpoints]

## Testing
- Backend: Tests for successful login, wrong password, and unknown email; verify token issuance. [Source: docs/architecture/development-workflow.md#backend-testing]
- Frontend: Test login form submit flow, token storage, and redirect to `/dashboard`. [Source: docs/architecture/development-workflow.md#frontend-testing]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.1 | Initial draft created for Story 1.4 | Scrum Master |

## Dev Agent Record
### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be completed by QA Agent_

