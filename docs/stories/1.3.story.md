# Story 1.3: User Registration

## Status
Ready for Review

## Story
As a new user, I want to create an account using my email and a password, so that I can start using the application.

## Acceptance Criteria
1. The frontend has a registration page with email and password fields.
2. The backend exposes a `/register` endpoint.
3. The user's password is securely hashed with salt before being stored in the database.
4. The system prevents registration with an email address that is already in use.
5. Upon successful registration, the user is redirected to the login page.

## Tasks / Subtasks
- [x] Frontend: Registration page UI and flow (AC: 1, 5)
  - [x] Implement form on `SignUpPage` with `email` and `password` fields using MUI components [Source: docs/architecture/frontend-architecture.md#react-component-hierarchy]
  - [x] Wire form submission to call backend endpoint for user creation [Source: docs/architecture/frontend-architecture.md#routing-strategy]
  - [x] On success, navigate to `/login` (redirect) and show a success message [Source: docs/architecture/frontend-architecture.md#routing-strategy]
- [x] Backend: Registration endpoint (AC: 2, 3, 4)
  - [x] Implement handler logic in `internal/api/handlers/auth.go::Register` to parse JSON `{ email, password }` and create user [Source: docs/architecture/backend-architecture.md#api-organization]
  - [x] Hash password with a per-user salt and store `password_hash` and `password_salt` [Source: docs/architecture/data-models.md#user-model]
  - [x] Enforce unique email via DB unique index; return appropriate error on conflict [Source: docs/architecture/database-schema.md#sqlite-schema-definition]
  - [x] Route should align with API spec (`POST /api/v1/users`) while PRD mentions `/register` — resolve by using spec route and documenting discrepancy [Source: docs/architecture/api-specification.md#user--authentication-endpoints]
- [x] Database: Ensure `users` table exists (dependency on Story 1.2) (AC: 3, 4)
  - [x] Use migration runner to apply user table migration before testing registration [Source: docs/architecture/backend-architecture.md#migration-strategy]
- [x] Tests
  - [x] Backend: Add test covering successful registration and duplicate email error [Source: docs/architecture/development-workflow.md#backend-testing]
  - [x] Frontend: Add component test for SignUpPage rendering and submit flow (mock API) [Source: docs/architecture/development-workflow.md#frontend-testing]

## Dev Notes
The following guidance is extracted from architecture and PRD; no assumptions beyond cited sources.

### Previous Story Insights
- Story 1.2 establishes the database and migrations. Registration depends on the `users` table migration being applied. [Source: docs/stories/1.2.story.md]

### API Specifications
- User creation endpoint is defined as `POST /api/v1/users` returning a new user payload; no auth required for sign-up. [Source: docs/architecture/api-specification.md#user--authentication-endpoints]
- PRD mentions a `/register` endpoint; treat as a naming variant. Prefer API spec path in implementation and update PRD or add an alias if needed. [Source: docs/prd/epic-1-foundation-user-onboarding.md]

### Data Models
- User fields: `ID`, `Username`, `Email`, `PasswordHash`, `PasswordSalt`, timestamps. Registration collects `email` and `password`; `username` may be added later. [Source: docs/architecture/data-models.md#user-model]

### Database Schema
- `users` table with unique constraints on `email` and `username`; includes `password_hash` and `password_salt`, plus timestamps and an `updated_at` trigger. Handle duplicate email errors surfaced from unique index. [Source: docs/architecture/database-schema.md#sqlite-schema-definition]

### Backend Architecture
- Handlers live under `internal/api/handlers` and routes under `internal/api/routes/routes.go`. Implement `AuthHandler.Register` and wire via existing route mapping. [Source: docs/architecture/backend-architecture.md#go-package-structure]
- Password utilities are organized under `internal/utils/password.go` per structure; implement secure hashing with salt and use in registration flow. [Source: docs/architecture/backend-architecture.md#go-package-structure]
- Configuration covers server and database; no special auth secrets needed for registration. [Source: docs/architecture/backend-architecture.md#configuration-management]

### Frontend Architecture
- Public routes include `/signup` and `/login`. Registration form belongs on `SignUpPage`; successful registration redirects to `/login`. [Source: docs/architecture/frontend-architecture.md#routing-strategy]
- Use React 18 + TypeScript with MUI; wire network request from page/component, no global auth state needed for sign-up. [Source: docs/architecture/tech-stack.md#technology-stack-table]

### File Locations / Project Structure
- Backend: `apps/backend/internal/api/handlers/auth.go`, `apps/backend/internal/api/routes/routes.go`, `apps/backend/internal/utils/password.go`, `apps/backend/internal/database/*`. [Source: docs/architecture/backend-architecture.md#go-package-structure]
- Frontend: `apps/frontend/src/pages/SignUpPage.tsx` and route configuration within `App.tsx`/router. [Source: docs/architecture/source-tree.md#monorepo-organization]

### Testing Requirements
- Backend unit/integration tests for registration success and duplicate email; use Go `testing`. [Source: docs/architecture/development-workflow.md#backend-testing]
- Frontend component test for form rendering and submit; use RTL/Jest/Vitest as configured. [Source: docs/architecture/development-workflow.md#frontend-testing]

### Technical Constraints
- Tech stack: Go 1.22.x backend with standard library; SQLite 3.x; React 18 + TypeScript frontend with MUI. [Source: docs/architecture/tech-stack.md#technology-stack-table]

### Project Structure Notes
- Discrepancy: PRD references `/register`; API spec and current routing use `POST /api/v1/users` for sign-up. Implement per API spec and optionally add an alias if product requires the `/register` path. Document this for the PO. [Source: docs/architecture/api-specification.md#user--authentication-endpoints]

## Testing
- Backend: Test that `POST /api/v1/users` creates a user with hashed password and that reusing the same email returns a conflict/validation error. [Source: docs/architecture/development-workflow.md#backend-testing]
- Frontend: Test that submitting the signup form with valid input triggers the API call and navigates to `/login` on success. [Source: docs/architecture/development-workflow.md#frontend-testing]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.1 | Initial draft created for Story 1.3 | Scrum Master |

## Dev Agent Record
### Agent Model Used
James (dev) via OpenAI Assistant

### Debug Log References
- 2025-08-19: Backend tests passed `apps/backend` (auth registration, duplicate email)
- 2025-08-19: Frontend tests passed `apps/frontend` (SignUp submit success)

### Completion Notes List
- Implemented `POST /api/v1/users` for sign-up; PRD `/register` noted as discrepancy (no alias added).
- Passwords hashed using per-user random salt + SHA-256; consider Argon2/scrypt in future.
- Unique email enforced via SQLite unique index; returns 409 on conflict.
- SignUp page posts to API and redirects to `/login` on success; shows inline success/error messages.

### File List
- apps/backend/internal/api/handlers/auth.go (updated)
- apps/backend/internal/api/handlers/auth_test.go (added)
- apps/backend/internal/utils/password.go (added)
- apps/frontend/src/pages/SignUpPage.tsx (updated)
- apps/frontend/src/pages/SignUpPage.test.tsx (added)

## QA Results

### Review Date: 2025-08-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation aligns with the API spec (`POST /api/v1/users`) and frontend uses it correctly. Input parsing uses `DisallowUnknownFields`, errors are handled with appropriate status codes, and duplicate email conflicts are mapped to 409. Passwords are salted and hashed; however, SHA-256 is used instead of a modern KDF (bcrypt/scrypt/Argon2), which is acceptable for MVP but a security concern to address. Logging/observability in handlers is minimal. Frontend flow is straightforward and user feedback is shown on success and conflict.

### Refactoring Performed

- File: apps/backend/internal/api/handlers/auth.go
  - Change: Added server-side email format validation using `net/mail.ParseAddress` returning 400 on invalid email.
  - Why: Defense-in-depth; avoid storing malformed addresses and improve input validation beyond frontend hints.
  - How: Early validation after required fields check; returns `invalid email format` with HTTP 400.
- File: apps/backend/internal/api/handlers/auth_test.go
  - Change: Added `TestRegister_InvalidEmail` to assert 400 on malformed email.
  - Why: Ensures validation behavior is covered and prevents regressions.
  - How: New test POSTs `{ email: "not-an-email", password: "secret123" }` and expects 400.

### Compliance Check

- Coding Standards: ✓ Basic Go conventions followed; early returns and clear error handling
- Project Structure: ✓ Matches documented directories for handlers/routes/utils
- Testing Strategy: ✓ Unit tests cover success and duplicate; frontend component test covers success path
- All ACs Met: ✓ Note: AC#2 names `/register`, implementation uses `/api/v1/users` per API spec; documented discrepancy acknowledged in story tasks

### Improvements Checklist

- [ ] Switch to a strong password hashing KDF (bcrypt/scrypt/Argon2) using `golang.org/x/crypto`
- [ ] Add minimum password policy checks (length/complexity) in backend
- [ ] Add rate limiting and/or CAPTCHA to registration to mitigate abuse
- [ ] Add structured logging in auth handlers for observability (without leaking sensitive data)
- [ ] Frontend test: assert navigate to `/login` is called on success
- [ ] Add integration test covering end-to-end registration happy path

### Security Review

SHA-256 with salt provides basic protection but is not a memory-hard password hashing function; recommend migrating to bcrypt/Argon2 before production. No rate limiting/CAPTCHA on registration; consider adding before public launch. Input validation strengthened with server-side email check.

### Performance Considerations

Low risk footprint; single INSERT and hashing per request. No immediate concerns.

### Files Modified During Review

- apps/backend/internal/api/handlers/auth.go
- apps/backend/internal/api/handlers/auth_test.go

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.3-user-registration.yml
Risk profile: docs/qa/assessments/1.3-risk-20250821.md
NFR assessment: docs/qa/assessments/1.3-nfr-20250821.md

### Recommended Status

[✓ Ready for Done] with security follow-ups tracked; see checklist above
(Story owner decides final status)
