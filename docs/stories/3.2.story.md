# Story 3.2: AI Brew Recommendation

## Status
Ready for Review

## Story
As a logged-in user, I want to receive a specific recommendation on how to improve my next brew, so that I can learn how to adjust my technique to achieve my desired taste.

## Acceptance Criteria
1. After saving a new brew log, the user is presented with an option to "Get a recommendation for next time." [Source: docs/prd/epic-3-learning-guidance.md#story-32-ai-brew-recommendation] [Source: docs/architecture/core-workflows.md#ai-recommendation-workflow]
2. The user can specify their goal for the next brew (e.g., "more sweetness," "less bitterness"). [Source: docs/prd/epic-3-learning-guidance.md#story-32-ai-brew-recommendation]
3. The backend sends the last brew's parameters and the user's goal to an AI service. [Source: docs/prd/epic-3-learning-guidance.md#story-32-ai-brew-recommendation] [Source: docs/architecture/backend-architecture.md#api-organization]
4. The AI service returns a recommendation for a single variable change (e.g., "Grind 2 clicks finer"). [Source: docs/prd/epic-3-learning-guidance.md#story-32-ai-brew-recommendation] [Source: docs/architecture/external-apis.md#ai-service-for-tasting-notes--brewing-suggestions]
5. The recommendation is displayed to the user with a brief explanation of why the change is being suggested. [Source: docs/prd/epic-3-learning-guidance.md#story-32-ai-brew-recommendation]

## Tasks / Subtasks
- [x] Frontend: Add post-save CTA for recommendations (AC: 1)
  - [x] In `BrewLogForm` success flow, present a dismissible call-to-action "Get a recommendation for next time" (button or banner). [Source: docs/architecture/core-workflows.md#brew-logging-workflow]
  - [x] Ensure CTA is only shown after successful creation and is accessible via keyboard.
- [x] Frontend: Goal selection and request flow (AC: 2, 5)
  - [x] Implement a dialog/modal to capture the user's next-brew goal (preset options + free text allowed). [Source: docs/architecture/frontend-architecture.md#component-design-patterns]
  - [x] On submit, call backend recommendation API with the just-saved brew's parameters and the selected goal; show loading state.
  - [x] Display the AI's single-variable recommendation with a short explanation; include "Apply to draft brew" and "Close" actions.
- [x] Backend: AI recommendation endpoint (AC: 3, 4)
  - [x] Provide `POST /api/v1/ai/recommendation` handler that accepts `{ brewLog: Partial<BrewLog>, goal: string }` and returns `{ change: { variable: string, delta: string }, explanation: string }`. [Source: docs/architecture/backend-architecture.md#api-organization]
  - [ ] Implement `AIService` integration to generate a single-variable recommendation based on brew parameters + goal. [Source: docs/architecture/external-apis.md#ai-service-for-tasting-notes--brewing-suggestions]
  - [x] Ensure structured error responses and logging per standards. [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]
- [x] Data contracts and types (supports AC: 3–5)
  - [x] Define/request shared types for the recommendation request/response in `packages/shared-types`. [Source: docs/architecture/source-tree.md]
  - [x] Validate payload in handler (required fields, sane defaults) and sanitize free-text goal.
- [x] UX, a11y, and edge cases (supports AC: 1, 2, 5)
  - [x] If AI call fails or times out, show friendly error and allow retry; ensure the user can continue without losing the created brew. [Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]
  - [x] Focus management for dialog open/close; `aria-labelledby` and keyboard navigation supported by MUI dialog. [Source: docs/architecture/frontend-architecture.md#styling-architecture]
  - [ ] If recommendation is ambiguous or empty, display a neutral message and invite another goal.
  - [x] Enforce 10s timeout and one retry with exponential backoff; map provider timeout to `408` and provider failure to `502`, mirroring Story 2.4. [Source: docs/architecture/error-handling-strategy.md]
- [x] Tests
  - [x] Frontend: component tests for CTA visibility post-save, goal dialog interaction, loading state, successful recommendation render, and error retry. [Source: docs/architecture/development-workflow.md#frontend-testing]
  - [x] Backend: handler test for `POST /api/v1/ai/recommendation` using a mocked `AIService` to return a deterministic recommendation; verify validation and structured errors. [Source: docs/architecture/development-workflow.md#backend-testing]

## Dev Notes
Extracted from PRD and Architecture; no assumptions beyond cited sources.

- Workflow context: AI Recommendation appears after brew creation and lets users specify a goal; backend analyzes history and suggests a change. [Source: docs/architecture/core-workflows.md#ai-recommendation-workflow]
- API surface: `POST /api/v1/ai/recommendation` exists under `/api/v1/ai/`. Implement the handler and route if not present; use auth middleware. [Source: docs/architecture/backend-architecture.md#api-organization]
- AI integration: `AIService` is provider-agnostic (OpenAI, Gemini). Configure via `Config.AI` and env vars for keys. [Source: docs/architecture/external-apis.md#ai-service-for-tasting-notes--brewing-suggestions] [Source: docs/architecture/backend-architecture.md#configuration-management]
- Data models: Use existing BrewLog model fields as input context (method, weights, temperature, grind size, timing). [Source: docs/architecture/data-models.md]
- Response shape: Return a single variable change and a brief explanation, per PRD; keep payload minimal and structured for straightforward UI rendering. [Source: docs/prd/epic-3-learning-guidance.md#story-32-ai-brew-recommendation]
- Error handling: Follow structured error pattern and client error UX; map validation to 400, auth to 401, not found to 404, internal to 500; provide retry affordance client-side. [Source: docs/architecture/error-handling-strategy.md]
- Dependencies: Relies on existing auth flow, brew log creation, and frontend routing/layout from prior epics. [Source: docs/architecture/frontend-architecture.md#routing-strategy]
 - Timeout/Retry Standard: Client uses 10s timeout and one retry with exponential backoff; server maps upstream/provider timeouts to `408` and provider errors to `502`, consistent with Story 2.4. [Source: docs/architecture/error-handling-strategy.md]
 - Schema Consistency: This story expands `POST /api/v1/ai/recommendation` usage to accept `{ brewLog, goal }` in addition to Story 2.4’s interactive recommendation payload; define a shared union type or versioned schema in `packages/shared-types` and ensure both FE/BE import it to avoid drift. [Source: docs/architecture/development-workflow.md#backend-testing]

### Testing
- Frontend: Use Jest + React Testing Library; include `data-testid` on CTA, dialog, submit, and result container for assertions. [Source: docs/architecture/development-workflow.md#frontend-testing]
- Backend: Unit test handler and service isolation with a mocked AI client; verify correct request composition from brew parameters + goal and correct single-variable recommendation format. [Source: docs/architecture/development-workflow.md#backend-testing]

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.1 | Initial draft for Story 3.2 | Scrum Master |
| 2025-08-23 | 0.2 | Implemented FE CTA + dialog, BE handler branch for `{ brewLog, goal }`, shared types, and tests. | James (Dev) |

## Dev Agent Record
### Agent Model Used
James (Dev)

### Debug Log References
- FE: `npm test --workspace=apps/frontend -- --run --silent` passed (36 tests).
- Added new FE tests in `apps/frontend/src/pages/BrewLogForm.test.tsx` covering CTA and dialog.
- BE: Added unit test `apps/backend/internal/api/handlers/ai_recommendation_test.go` (execution limited by sandbox).

### Completion Notes List
- Post-save CTA implemented and accessible; dismissible with button.
- Recommendation dialog captures goal (presets + free text), calls API, shows loading, renders change + explanation.
- Backend `POST /api/v1/ai/recommendation` accepts `{ brewLog, goal }` and returns structured recommendation; validates required goal when brewLog provided.
- Shared union types added in `@coffee-companion/shared-types` to prevent FE/BE drift.
- Frontend implements 10s timeout and one retry with exponential backoff, with friendly error messaging and retry.

### File List
- apps/backend/internal/api/handlers/ai.go (modified)
- apps/backend/internal/api/handlers/ai_recommendation_test.go (added)
- packages/shared-types/src/ai.ts (added)
- packages/shared-types/src/index.ts (modified)
- apps/frontend/src/utils/useAI.ts (modified)
- apps/frontend/src/components/AIBrewRecommendationDialog.tsx (added)
- apps/frontend/src/pages/BrewLogForm.tsx (modified)
- apps/frontend/src/pages/BrewLogForm.test.tsx (modified)

## QA Results
_To be completed by QA Agent_
