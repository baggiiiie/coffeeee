# Story 2.7: User-Scoped Coffees Schema & API Refactor

## Status
Approved

## Story
As a developer, I want the coffees data model to be owned by the creating user and the API to reflect per-user idempotent creation, so that we eliminate the `user_coffees` join table and simplify logic while matching the approved product decision.

## Acceptance Criteria
1. Database schema: `apps/backend/migrations/001_initial_schema.sql` defines `coffees` with `user_id INTEGER NOT NULL` and a foreign key `FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE`. No `user_coffees` table exists in 001.
2. Indexes: `idx_coffees_user_id (user_id)` and `idx_coffees_user_name (user_id, name)` are created in 001. Existing `coffees` indexes remain.
3. Remove migration 002: `apps/backend/migrations/002_user_coffees.up.sql` and `002_user_coffees.down.sql` are deleted from the repo.
4. API Create: `POST /api/v1/coffees` (CreateForMe) finds-or-creates by `(user_id, name, origin?, roaster?)`, inserts with `user_id` and `photo_path` (if provided), and returns `{ "coffee": { ... } }` with no `link` object.
5. Codebase cleanup: No remaining references to `user_coffees` in backend code. Search confirms zero matches for `user_coffees` identifiers.
6. Docs alignment: Update docs to reflect user-owned coffees and no `user_coffees` table:
   - `docs/architecture/database-schema.md` shows `coffees` with `user_id` and updates relationships to reflect one-to-many User→Coffees; remove join-table references.
   - `docs/prd/epic-2-coffee-brew-logging.md` Story 2.1 AC (3) clarifies find-or-create owned by the logged-in user and photo on `coffees`.
   - `docs/stories/2.6.story.md` tasks/notes updated to store `photo_path` on `coffees` (not join table) and to use a coffee-scoped upload or creation path consistent with the refactor.
7. Tests: Backend tests validate idempotent creation for a user, distinct records across users, and absence of `user_coffees` logic.

## Tasks / Subtasks
- [x] Schema update (AC: 1, 2)
  - [x] Edit `apps/backend/migrations/001_initial_schema.sql` to add `user_id` to `coffees` with FK to `users(id)` and create indexes `idx_coffees_user_id`, `idx_coffees_user_name`. Keep existing `photo_path`, timestamps, and update trigger. [Source: docs/architecture/database-schema.md#sqlite-schema-definition]
- [x] Remove obsolete migrations (AC: 3)
  - [x] Delete `apps/backend/migrations/002_user_coffees.up.sql` and `002_user_coffees.down.sql`. [Source: docs/architecture/backend-architecture.md#migration-strategy]
- [x] API handler refactor (AC: 4)
  - [x] In `apps/backend/internal/api/handlers/coffee.go#CreateForMe`, query by `user_id + name + IFNULL(origin,'') + IFNULL(roaster,'')`. Insert includes `user_id` and `photo_path`. Remove any `user_coffees` inserts/selects and associated unique-constraint handling. [Source: docs/architecture/backend-architecture.md#api-organization]
  - [x] Response body returns only `coffee` with timestamps and optional `photoPath`. [Source: docs/architecture/api-specification.md]
- [x] Codebase cleanup (AC: 5)
  - [x] Search for `user_coffees` in repo and remove or refactor any remaining references. [Source: docs/architecture/development-workflow.md#backend-testing]
- [ ] Documentation updates (AC: 6)
  - [ ] Update `docs/architecture/database-schema.md` to include `user_id` on coffees, add indexes, and update relationships: User→Coffees (one-to-many), Coffee→BrewLogs (one-to-many), User→BrewLogs (one-to-many). Remove join-table mention. [Source: docs/architecture/database-schema.md#database-relationships]
  - [ ] Update `docs/prd/epic-2-coffee-brew-logging.md` Story 2.1 AC (3) as approved. [Source: docs/prd/epic-2-coffee-brew-logging.md#story-21-create-coffee-journey-log]
  - [ ] Update `docs/stories/2.6.story.md` to store `photo_path` on `coffees` and adjust any endpoint/task text that references `user_coffees`. [Source: docs/stories/2.6.story.md]
- [x] Tests (AC: 7)
  - [x] Add/adjust tests for CreateForMe idempotency and cross-user distinctness; remove tests involving `user_coffees`. [Source: docs/architecture/development-workflow.md#backend-testing]

## Dev Notes
- API is REST under `/api/v1`; use existing auth middleware to resolve the current user ID for CreateForMe. [Source: docs/architecture/backend-architecture.md#api-organization]
- Migration strategy is version-controlled; since setup runs 001 directly, editing 001 is acceptable for fresh environments per our process. [Source: docs/architecture/backend-architecture.md#migration-strategy]
- Schema considerations: SQLite composite uniqueness with NULLs is tricky; rely on application-level find-or-create using `IFNULL` comparisons as currently done. [Source: docs/architecture/database-schema.md#sqlite-schema-definition]
- Error handling should follow the structured error pattern (code/message) already used in handlers. [Source: docs/architecture/error-handling-strategy.md#backend-error-handling]

## Testing
- Unit/integration tests for `CreateForMe` covering:
  - Same user + same (name, origin, roaster) twice → returns the same coffee (no duplicates).
  - Different users with same fields → separate coffee records.
  - Optional `photoPath` persisted on `coffees.photo_path`.
- Ensure no code path references `user_coffees`.

## Change Log
| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| {{DATE}} | 0.1 | Initial draft for Story 2.7 | Scrum Master |

## Dev Agent Record
### Agent Model Used
James (Dev)

### Debug Log References
- Ran backend tests with `GOCACHE=apps/backend/.gocache` due to sandboxing.
- Verified no `user_coffees` references remain in backend code.

### Completion Notes List
- Added `user_id` to `coffees` with FK and indexes.
- Removed `002_user_coffees` migrations per approved change.
- Refactored `CreateForMe` to per-user find-or-create; returns only `coffee`.
- Persist/updated `photo_path` on `coffees` for owner.
- Rewrote tests for idempotency and cross-user distinctness; adjusted migration test to handle single-migration scenario.

### File List
- apps/backend/migrations/001_initial_schema.sql (updated)
- apps/backend/migrations/002_user_coffees.up.sql (deleted)
- apps/backend/migrations/002_user_coffees.down.sql (deleted)
- apps/backend/internal/api/handlers/coffee.go (updated)
- apps/backend/internal/api/handlers/coffee_user_test.go (updated)
- apps/backend/internal/migrate/runner_test.go (updated)

## QA Results
_To be completed by QA Agent_
